
<!doctype html>
<!--[if lt IE 7]><html class="no-js lt-ie9 lt-ie8 lt-ie7" lang="en"> <![endif]-->
<!--[if (IE 7)&!(IEMobile)]><html class="no-js lt-ie9 lt-ie8" lang="en"><![endif]-->
<!--[if (IE 8)&!(IEMobile)]><html class="no-js lt-ie9" lang="en"><![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en"><!--<![endif]-->
<head>
<meta charset="utf-8">
<title>Latest Posts &#8211; Spencer's Blog</title>
<meta name="description" content="Describe this nonsense.">
<meta name="keywords" content="Jekyll, theme, themes, responsive, blog, modern">



<!-- Open Graph -->
<meta property="og:locale" content="en_US">
<meta property="og:type" content="article">
<meta property="og:title" content="Latest Posts">
<meta property="og:description" content="Describe this nonsense.">
<meta property="og:url" content="https://rsmitty.github.io/">
<meta property="og:site_name" content="Spencer's Blog">





<link rel="canonical" href="https://rsmitty.github.io/">
<link href="https://rsmitty.github.io/feed.xml" type="application/atom+xml" rel="alternate" title="Spencer's Blog Feed">

<!-- http://t.co/dKP3o1e -->
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- For all browsers -->
<link rel="stylesheet" href="https://rsmitty.github.io/assets/css/main.css">
<!-- Webfonts -->
<link href="//fonts.googleapis.com/css?family=Lato:300,400,700,300italic,400italic" rel="stylesheet" type="text/css">

<meta http-equiv="cleartype" content="on">

<!-- Load Modernizr -->
<script src="https://rsmitty.github.io/assets/js/vendor/modernizr-2.6.2.custom.min.js"></script>

<!-- Icons -->
<!-- 16x16 -->
<link rel="shortcut icon" href="https://rsmitty.github.io/favicon.ico">
<!-- 32x32 -->
<link rel="shortcut icon" href="https://rsmitty.github.io/favicon.png">
<!-- 57x57 (precomposed) for iPhone 3GS, pre-2011 iPod Touch and older Android devices -->
<link rel="apple-touch-icon-precomposed" href="https://rsmitty.github.io/images/apple-touch-icon-precomposed.png">
<!-- 72x72 (precomposed) for 1st generation iPad, iPad 2 and iPad mini -->
<link rel="apple-touch-icon-precomposed" sizes="72x72" href="https://rsmitty.github.io/images/apple-touch-icon-72x72-precomposed.png">
<!-- 114x114 (precomposed) for iPhone 4, 4S, 5 and post-2011 iPod Touch -->
<link rel="apple-touch-icon-precomposed" sizes="114x114" href="https://rsmitty.github.io/images/apple-touch-icon-114x114-precomposed.png">
<!-- 144x144 (precomposed) for iPad 3rd and 4th generation -->
<link rel="apple-touch-icon-precomposed" sizes="144x144" href="https://rsmitty.github.io/images/apple-touch-icon-144x144-precomposed.png">



</head>

<body id="post-index" class="feature">

<!--[if lt IE 9]><div class="upgrade"><strong><a href="http://whatbrowser.org/">Your browser is quite old!</strong> Why not upgrade to a different browser to better enjoy this site?</a></div><![endif]-->
<nav id="dl-menu" class="dl-menuwrapper" role="navigation">
	<button class="dl-trigger">Open Menu</button>
	<ul class="dl-menu">
		<li><a href="https://rsmitty.github.io/">Home</a></li>
		<li>
			<a href="#">About</a>
			<ul class="dl-submenu">
				<li>
					<img src="https://rsmitty.github.io/images/avatar.jpg" alt="Spencer Smith photo" class="author-photo">
					<h4>Spencer Smith</h4>
					<p>Cloud Engineer working extensively with Linux, OpenStack, and various automation tools. Fan of OSS.</p>
				</li>
<!--				<li><a href="https://rsmitty.github.io/about/"><span class="btn btn-inverse">Learn More</span></a></li> -->
				<li>
					<a href="mailto:robertspencersmith@gmail.com"><i class="fa fa-fw fa-envelope"></i> Email</a>
				</li>
				
				
				
				<li>
					<a href="https://linkedin.com/in/spencersmith23"><i class="fa fa-fw fa-linkedin"></i> LinkedIn</a>
				</li>
				<li>
					<a href="https://github.com/rsmitty"><i class="fa fa-fw fa-github"></i> GitHub</a>
				</li>
				
				
				
				
			</ul><!-- /.dl-submenu -->
		</li>
		<li>
			<a href="#">Posts</a>
			<ul class="dl-submenu">
				<li><a href="https://rsmitty.github.io/posts/">All Posts</a></li>
				<li><a href="https://rsmitty.github.io/tags/">All Tags</a></li>
			</ul>
		</li>
		
	</ul><!-- /.dl-menu -->
</nav><!-- /.dl-menuwrapper -->


<div class="entry-header">
  <div class="image-credit">Image source: <a href="http://www.dargadgetz.com/ios-7-abstract-wallpaper-pack-for-iphone-5-and-ipod-touch-retina/">dargadgetz</a></div><!-- /.image-credit -->
  
    <div class="entry-image">
      <img src="https://rsmitty.github.io/images/abstract-1.jpg" alt="Latest Posts">
    </div><!-- /.entry-image -->
  
  <div class="header-title">
    <div class="header-title-wrap">
      <h1>Spencer's Blog</h1>
      <h2>Latest Posts</h2>
    </div><!-- /.header-title-wrap -->
  </div><!-- /.header-title -->
</div><!-- /.entry-header -->

<div id="main" role="main">
  
<article class="hentry">
  <header>
    
    <div class="entry-meta">
      <span class="entry-date date published updated"><time datetime="2017-03-23T00:00:00-04:00"><a href="https://rsmitty.github.io/KubeDNS-Tweaks/">March 23, 2017</a></time></span><span class="author vcard"><span class="fn"><a href="https://rsmitty.github.io/about/" title="About Spencer Smith">Spencer Smith</a></span></span>
      
      <span class="entry-reading-time">
        <i class="fa fa-clock-o"></i>
        
Reading time ~6 minutes
      </span><!-- /.entry-reading-time -->
      
    </div><!-- /.entry-meta -->
    
      <h1 class="entry-title"><a href="https://rsmitty.github.io/KubeDNS-Tweaks/" rel="bookmark" title="KubeDNS Tweaks for Performance" itemprop="url">KubeDNS Tweaks for Performance</a></h1>
    
  </header>
  <div class="entry-content">
    <p>Hey y’all. Wanted to document some of the stranger bits I’ve encountered while running Kubernetes with one of my clients. We’ve finally got some decent sized clusters running in their environment and they’re being heavily utilized by developers, as they push new or rewritten services into the cluster. Win! That said, we got some complaints about the network performance these guys were seeing. It sounded like intra-cluster communication was working well, but trying to connect to other systems outside of the cluster or things on the public internet were really slow. Like anywhere between 4-10 seconds to resolve the names. Uh oh. Here’s some of what we did to help work around that, as well as how we figured it out.</p>

<h2 id="basics"><strong>Basics</strong></h2>

<p>So we had traditionally just been deploying the official KubeDNS deployment that is part of the Kubernetes repo. Or, rather, we were using the one that Kargo deploys, which is just a copy of the former. We’ll still be using that as our basis. It’s also important to note that the pod that’s deployed is 3 containers: kubedns, dnsmasq, and a sidecar for health checking. The names of these seem to have changed very recently, but just know that the important ones are kubedns and dnsmasq.</p>

<p>The flow is basically this:</p>
<ul>
  <li>A request for resolution inside the cluster is directed to the kubedns service</li>
  <li>The dnsmasq container is the first that receives the request</li>
  <li>If the request is <code class="highlighter-rouge">cluster.local</code>, <code class="highlighter-rouge">in-addr.arpa</code>, or similar, it is forwarded to the kubedns container for resolution.</li>
  <li>If it’s something else, dnsmasq container queries the upstream DNS that’s present in its /etc/resolv.conf file.</li>
</ul>

<h2 id="logging"><strong>Logging</strong></h2>

<p>So, while all of the above seemed to be working, it was just slow. The first thing I tried to do was see if queries were making it to the dnsmasq container in a timely fashion. I dumped the logs with <code class="highlighter-rouge">kubectl logs -f -tail 100 -c dnsmasq -n kube-system kubedns-xxxyy</code>. I noticed quickly that there weren’t any logs of interest here:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">dnsmasq[1]: started, version 2.76 cachesize 1000
dnsmasq[1]: compile <span class="nb">time </span>options: IPv6 GNU-getopt no-DBus no-i18n no-IDN DHCP DHCPv6 no-Lua TFTP no-conntrack ipset auth no-DNSSEC loop-detect inotify
dnsmasq[1]: using nameserver 127.0.0.1#10053
dnsmasq[1]: <span class="nb">read</span> /etc/hosts - 7 addresses</code></pre></figure>

<p>I needed to enable log-queries:</p>
<ul>
  <li>You can do this by editing the RC with <code class="highlighter-rouge">kubectl edit rc -n kube-system kubedns</code>.</li>
  <li>Update the flags under the <code class="highlighter-rouge">dnsmasq</code> container to look like the following:</li>
</ul>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">...
      - args:
        - --log-facility<span class="o">=</span>-
        - --cache-size<span class="o">=</span>1000
        - --no-resolv
        - --server<span class="o">=</span>127.0.0.1#10053
        - --log-queries
...</code></pre></figure>

<ul>
  <li>Bounce the replicas with:</li>
</ul>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">kubectl scale rc -n kube-system kubedns --replicas<span class="o">=</span>0 <span class="o">&amp;&amp;</span> <span class="se">\</span>
kubectl scale rc -n kube-system kubedns --replicas<span class="o">=</span>1</code></pre></figure>

<p>Once the new pod is online you can then dump the logs again. You should see lots of requests flowing through, even on a small cluster.</p>

<h2 id="wtf-is-that"><strong>WTF Is That?</strong></h2>
<p>So now that I had some logs online, I started querying from inside of a pod. The first thing I ran was something like <code class="highlighter-rouge">time nslookup kubedns.kube-system.svc.cluster.local</code> to just simply look up something internal to the cluster. As soon as I did that, I saw a <em>TON</em> of queries and, while it eventually resolved, it was searching every. single. possible. name.</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">dnsmasq[1]: query[A] kubedns.kube-system.svc.cluster.local.kube-system.svc.cluster.local from 10.234.96.0
dnsmasq[1]: forwarded kubedns.kube-system.svc.cluster.local.kube-system.svc.cluster.local to 127.0.0.1
dnsmasq[1]: reply kubedns.kube-system.svc.cluster.local.kube-system.svc.cluster.local is NXDOMAIN
dnsmasq[1]: query[A] kubedns.kube-system.svc.cluster.local.svc.cluster.local from 10.234.96.0
dnsmasq[1]: forwarded kubedns.kube-system.svc.cluster.local.svc.cluster.local to 127.0.0.1
dnsmasq[1]: reply kubedns.kube-system.svc.cluster.local.svc.cluster.local is NXDOMAIN
dnsmasq[1]: query[A] kubedns.kube-system.svc.cluster.local.cluster.local from 10.234.96.0
dnsmasq[1]: forwarded kubedns.kube-system.svc.cluster.local.cluster.local to 127.0.0.1
dnsmasq[1]: reply kubedns.kube-system.svc.cluster.local.cluster.local is NXDOMAIN
dnsmasq[1]: query[A] kubedns.kube-system.svc.cluster.local.default.svc.cluster.local from 10.234.96.0
dnsmasq[1]: forwarded kubedns.kube-system.svc.cluster.local.default.svc.cluster.local to 127.0.0.1
dnsmasq[1]: reply kubedns.kube-system.svc.cluster.local.default.svc.cluster.local is NXDOMAIN
dnsmasq[1]: query[A] kubedns.kube-system.svc.cluster.local.svc.cluster.local from 10.234.96.0
dnsmasq[1]: forwarded kubedns.kube-system.svc.cluster.local.svc.cluster.local to 127.0.0.1
dnsmasq[1]: reply kubedns.kube-system.svc.cluster.local.svc.cluster.local is NXDOMAIN
dnsmasq[1]: query[A] kubedns.kube-system.svc.cluster.local.us-west-2.compute.internal from 10.234.96.0
dnsmasq[1]: forwarded kubedns.kube-system.svc.cluster.local.us-west-2.compute.internal to 127.0.0.1
dnsmasq[1]: query[A] kubedns.kube-system.svc.cluster.local.compute.internal from 10.234.96.0
dnsmasq[1]: forwarded kubedns.kube-system.svc.cluster.local.compute.internal to 127.0.0.1
dnsmasq[1]: reply kubedns.kube-system.svc.cluster.local.compute.internal is NXDOMAIN
dnsmasq[1]: query[A] kubedns.kube-system.svc.cluster.local from 10.234.96.0
dnsmasq[1]: forwarded kubedns.kube-system.svc.cluster.local to 127.0.0.1
dnsmasq[1]: reply kubedns.kube-system.svc.cluster.local is 10.233.0.3</code></pre></figure>

<p>Once I did this, I tried an exteral name to see similar results and a super slow lookup time:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">dnsmasq[1]: query[A] espn.com.kube-system.svc.cluster.local from 10.234.96.0
dnsmasq[1]: forwarded espn.com.kube-system.svc.cluster.local to 127.0.0.1
dnsmasq[1]: reply espn.com.kube-system.svc.cluster.local is NXDOMAIN
dnsmasq[1]: query[A] espn.com.svc.cluster.local from 10.234.96.0
dnsmasq[1]: forwarded espn.com.svc.cluster.local to 127.0.0.1
dnsmasq[1]: reply espn.com.svc.cluster.local is NXDOMAIN
dnsmasq[1]: query[A] espn.com.cluster.local from 10.234.96.0
dnsmasq[1]: forwarded espn.com.cluster.local to 127.0.0.1
dnsmasq[1]: reply espn.com.cluster.local is NXDOMAIN
dnsmasq[1]: query[A] espn.com.default.svc.cluster.local from 10.234.96.0
dnsmasq[1]: forwarded espn.com.default.svc.cluster.local to 127.0.0.1
dnsmasq[1]: reply espn.com.default.svc.cluster.local is NXDOMAIN
dnsmasq[1]: query[A] espn.com.svc.cluster.local from 10.234.96.0
dnsmasq[1]: forwarded espn.com.svc.cluster.local to 127.0.0.1
dnsmasq[1]: reply espn.com.svc.cluster.local is NXDOMAIN
dnsmasq[1]: query[A] espn.com.us-west-2.compute.internal from 10.234.96.0
dnsmasq[1]: forwarded espn.com.us-west-2.compute.internal to 127.0.0.1
dnsmasq[1]: query[A] espn.com.compute.internal from 10.234.96.0
dnsmasq[1]: forwarded espn.com.compute.internal to 127.0.0.1
dnsmasq[1]: reply espn.com.compute.internal is NXDOMAIN
dnsmasq[1]: query[A] espn.com from 10.234.96.0
dnsmasq[1]: forwarded espn.com to 127.0.0.1
dnsmasq[1]: reply espn.com is 199.181.132.250</code></pre></figure>

<p>What’s happening? <strong>It’s the ndots.</strong> KubeDNS is hard coded with an ndots value of 5. This means that any request for resolution that contains fewer than 5 dots will cycle through all of the search domains as well in an attempt to resolve. You can see both of these by dumping the /etc/resolv.conf file from the dnsmasq container:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="gp">$ </span>kubectl <span class="nb">exec</span> -ti kubedns-mg3tt -n kube-system -c dnsmasq cat /etc/resolv.conf
search default.svc.cluster.local svc.cluster.local us-west-2.compute.internal compute.internal
nameserver wwww.xxx.yyy.zzzz
options attempts:2
options ndots:5</code></pre></figure>

<p>It turns out that this is kind of a known issue within KubeDNS if your google-fu is strong enough to find it. Here’s a couple of good links for some context:</p>
<ul>
  <li>https://github.com/kubernetes/kubernetes/issues/33554</li>
  <li>https://github.com/kubernetes/kubernetes/issues/14051</li>
  <li>https://github.com/kubernetes/kubernetes/issues/27679</li>
</ul>

<h2 id="duct-tape-it"><strong>Duct Tape It!</strong></h2>
<p>Okay, so from what I was reading, it looked like there wasn’t a good consensus on how to fix this, even though an ndots of 3 would have mostly resolved this issue for us. Or at least sped things up enough that we would have been okay with it. And yet, here we are. So we’ve got to speed this up somehow.</p>

<p>I started reading a bit more about dnsmasq and how we could avoid searching for all of those domain names when we know they don’t exist. Enter the <code class="highlighter-rouge">address</code> flag. This is a dnsmasq flag that you can use to return a defined IP to any request that matches the listed domains. But, if you don’t provide the IP it simply returns an NXDOMAIN very quickly and thus doesn’t bother forwarding requests up to kubedns or your upstream nameserver. This wound up being the biggest part of our fix. The only real pain in the butt is that you have to list <strong>all</strong> the domains you want to catch. We gave it a good shot, but I’m sure there’s more that could be listed. A minor extra is the <code class="highlighter-rouge">--no-negcache</code> flag. Because we’re sending so many NXDOMAIN responses around, we don’t want to cache them because it’ll eat our whole cache.</p>

<p>The other big part to consider is the <code class="highlighter-rouge">server</code> flag. This one allows us to specify for a given domain which DNS server should be queried. This seems to actually have been added into the master branch of Kubernetes now as well.</p>

<p>So here’s how to fix it:</p>
<ul>
  <li>Edit the dnsmasq args to look like the following:</li>
</ul>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">    - args:
      - --log-facility<span class="o">=</span>-
      - --cache-size<span class="o">=</span>10000
      - --no-resolv
      - --server<span class="o">=</span>/cluster.local/127.0.0.1#10053
      - --server<span class="o">=</span>/in-addr.arpa/127.0.0.1#10053
      - --server<span class="o">=</span>/ip6.arpa/127.0.0.1#10053
      - --server<span class="o">=</span>www.xxx.yyy.zzz
      - --log-queries
      - --no-negcache
      - --address<span class="o">=</span>/org.cluster.local/org.svc.cluster.local/org.default.svc.cluster.local/com.cluster.local/com.svc.cluster.local/com.default.svc.cluster.local/net.cluster.local/net.svc.cluster.local/net.default.svc.cluster.local/com.compute.internal/net.compute.internal/com.us-west-2.compute.internal/net.us-west-2.compute.internal/svc.svc.cluster.local/</code></pre></figure>

<ul>
  <li>You may find that you want to add more domains as they are relevant to you. We’ve got some internal domains in the address block that aren’t listed here.</li>
  <li>Notice the last server flag. It should point to your upstream DNS server. You can also supply several of these flags if necessary.</li>
  <li>Also note that you may not need to worry about the <code class="highlighter-rouge">compute.internal</code> domains unless you’re in AWS.</li>
  <li>Bounce the replicas again:</li>
</ul>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">kubectl scale rc -n kube-system kubedns --replicas<span class="o">=</span>0 <span class="o">&amp;&amp;</span> <span class="se">\</span>
kubectl scale rc -n kube-system kubedns --replicas<span class="o">=</span>1</code></pre></figure>

<p>That’s it! Hope this helps someone. It really sped up the request time for us. All requests respond in fractions of a second now it seems. I fought with this for a while, but at least had a chance to learn a bit more about how DNS works both inside and outside of Kubernetes.</p>

  </div><!-- /.entry-content -->
</article><!-- /.hentry -->

<article class="hentry">
  <header>
    
    <div class="entry-meta">
      <span class="entry-date date published updated"><time datetime="2017-03-15T00:00:00-04:00"><a href="https://rsmitty.github.io/Multi-Cloud-Swarm/">March 15, 2017</a></time></span><span class="author vcard"><span class="fn"><a href="https://rsmitty.github.io/about/" title="About Spencer Smith">Spencer Smith</a></span></span>
      
      <span class="entry-reading-time">
        <i class="fa fa-clock-o"></i>
        
Reading time ~8 minutes
      </span><!-- /.entry-reading-time -->
      
    </div><!-- /.entry-meta -->
    
      <h1 class="entry-title"><a href="https://rsmitty.github.io/Multi-Cloud-Swarm/" rel="bookmark" title="Multi-Cloud Docker Swarm with Terraform and Ansible" itemprop="url">Multi-Cloud Docker Swarm with Terraform and Ansible</a></h1>
    
  </header>
  <div class="entry-content">
    <p>Since the release of Docker 1.12, there’s a new Swarm mode that is baked into the Docker engine. I wanted to spend some time, after months of Kubernetes-only work, to check out how Swarm was doing things and to see how easy it was to get started. Building a quick cluster on your laptop or on a single provider seemed to be straight forward, but I couldn’t readily find a no nonsense way to spin one up across multiple clouds. So, you know, I went ahead and built one.</p>

<p>Today, we’ll walk through how you can create a multi-cloud Swarm on AWS and GCE. We will use Terraform and Ansible to complete the bootstrap process, which is surprisingly straightforward. You can go directly to the Github repo where I stashed the code by clicking <a href="https://github.com/rsmitty/cross-cloud-swarm">here</a>.</p>

<p>I’ll give an early preface and say that I’ve only used this for some testing and learning experience. It’s in no way prod. ready or as robust as it should be to accept lots of different configurations.</p>

<h2 id="outline"><strong>Outline</strong></h2>

<p>The deployment of our cluster will occur in the following order:</p>
<ul>
  <li>AWS infrastructure is provisioned (security groups and instances)</li>
  <li>GCE infrastructure is provisioned (firewall rules and instances)</li>
  <li>An Ansible inventory file is created in the current working directory</li>
  <li>Docker is installed and Swarm is initialized</li>
</ul>

<h2 id="terraform-scripts"><strong>Terraform Scripts</strong></h2>
<p>In order to create our infrastructure, we want to create three terraform scripts and a variable file. This will provide all of the necessary information that Terraform needs to do it’s thing.</p>

<ul>
  <li>Create four files: <code class="highlighter-rouge">touch 00-aws-infra.tf 01-gce-infra.tf 02-create-inv.tf variables.tf</code></li>
  <li>Open <code class="highlighter-rouge">variables.tf</code> for editing. We’ll populate this file with all of the configurable options that we will use for each cloud, as well as some general info that the instances have in common, regardless of cloud. Populate the file with the following:</li>
</ul>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="c">##General vars</span>
variable <span class="s2">"ssh_user"</span> <span class="o">{</span>
  default <span class="o">=</span> <span class="s2">"ubuntu"</span>
<span class="o">}</span>
variable <span class="s2">"public_key_path"</span> <span class="o">{</span>
  default <span class="o">=</span> <span class="s2">"/Users/spencer/.ssh/id_rsa.pub"</span>
<span class="o">}</span>
variable <span class="s2">"private_key_path"</span> <span class="o">{</span>
  default <span class="o">=</span> <span class="s2">"/Users/spencer/.ssh/id_rsa"</span>
<span class="o">}</span>
<span class="c">##AWS Specific Vars</span>
variable <span class="s2">"aws_worker_count"</span> <span class="o">{</span>
  default <span class="o">=</span> 1
<span class="o">}</span>
variable <span class="s2">"aws_key_name"</span> <span class="o">{</span>
  default <span class="o">=</span> <span class="s2">"spencer-key"</span>
<span class="o">}</span>
variable <span class="s2">"aws_instance_size"</span> <span class="o">{</span>
  default <span class="o">=</span> <span class="s2">"t2.micro"</span>
<span class="o">}</span>
variable <span class="s2">"aws_region"</span> <span class="o">{</span>
  default <span class="o">=</span> <span class="s2">"us-west-2"</span>
<span class="o">}</span>
<span class="c">##GCE Specific Vars</span>
variable <span class="s2">"gce_worker_count"</span> <span class="o">{</span>
  default <span class="o">=</span> 1
<span class="o">}</span>
variable <span class="s2">"gce_creds_path"</span> <span class="o">{</span>
  default <span class="o">=</span> <span class="s2">"/Users/spencer/gce-creds.json"</span>
<span class="o">}</span>
variable <span class="s2">"gce_project"</span> <span class="o">{</span>
  default <span class="o">=</span> <span class="s2">"test-project"</span>
<span class="o">}</span>
variable <span class="s2">"gce_region"</span> <span class="o">{</span>
  default <span class="o">=</span> <span class="s2">"us-central1"</span>
<span class="o">}</span>
variable <span class="s2">"gce_instance_size"</span> <span class="o">{</span>
  default <span class="o">=</span> <span class="s2">"n1-standard-1"</span>
<span class="o">}</span></code></pre></figure>

<ul>
  <li>
    <p>You can update these defaults if you desire, but also know that you can override these at runtime with the <code class="highlighter-rouge">-var</code> flag to terraform. See <a href="https://www.terraform.io/intro/getting-started/variables.html">here</a> for details.</p>
  </li>
  <li>
    <p>Now that we’ve got the variables we need, let’s work on creating our AWS infrastructure. Open <code class="highlighter-rouge">00-aws-infra.tf</code> and put in the following:</p>
  </li>
</ul>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="c">##Amazon Infrastructure</span>
provider <span class="s2">"aws"</span> <span class="o">{</span>
  region <span class="o">=</span> <span class="s2">"</span><span class="k">${</span><span class="nv">var</span><span class="p">.aws_region</span><span class="k">}</span><span class="s2">"</span>
<span class="o">}</span>

<span class="c">##Create swarm security group</span>
resource <span class="s2">"aws_security_group"</span> <span class="s2">"swarm_sg"</span> <span class="o">{</span>
  name        <span class="o">=</span> <span class="s2">"swarm_sg"</span>
  description <span class="o">=</span> <span class="s2">"Allow all inbound traffic necessary for Swarm"</span>
  ingress <span class="o">{</span>
    from_port   <span class="o">=</span> 22
    to_port     <span class="o">=</span> 22
    protocol    <span class="o">=</span> <span class="s2">"tcp"</span>
    cidr_blocks <span class="o">=</span> <span class="o">[</span><span class="s2">"0.0.0.0/0"</span><span class="o">]</span>
  <span class="o">}</span>
  ingress <span class="o">{</span>
    from_port   <span class="o">=</span> 2377
    to_port     <span class="o">=</span> 2377
    protocol    <span class="o">=</span> <span class="s2">"tcp"</span>
    cidr_blocks <span class="o">=</span> <span class="o">[</span><span class="s2">"0.0.0.0/0"</span><span class="o">]</span>
  <span class="o">}</span>
  ingress <span class="o">{</span>
    from_port   <span class="o">=</span> 7946
    to_port     <span class="o">=</span> 7946
    protocol    <span class="o">=</span> <span class="s2">"tcp"</span>
    cidr_blocks <span class="o">=</span> <span class="o">[</span><span class="s2">"0.0.0.0/0"</span><span class="o">]</span>
  <span class="o">}</span>
  ingress <span class="o">{</span>
    from_port   <span class="o">=</span> 7946
    to_port     <span class="o">=</span> 7946
    protocol    <span class="o">=</span> <span class="s2">"udp"</span>
    cidr_blocks <span class="o">=</span> <span class="o">[</span><span class="s2">"0.0.0.0/0"</span><span class="o">]</span>
  <span class="o">}</span>
  ingress <span class="o">{</span>
    from_port   <span class="o">=</span> 4789
    to_port     <span class="o">=</span> 4789
    protocol    <span class="o">=</span> <span class="s2">"tcp"</span>
    cidr_blocks <span class="o">=</span> <span class="o">[</span><span class="s2">"0.0.0.0/0"</span><span class="o">]</span>
  <span class="o">}</span>
  egress <span class="o">{</span>
    from_port <span class="o">=</span> 0
    to_port   <span class="o">=</span> 0
    protocol  <span class="o">=</span> <span class="s2">"-1"</span>
    cidr_blocks <span class="o">=</span> <span class="o">[</span>
      <span class="s2">"0.0.0.0/0"</span>,
    <span class="o">]</span>
  <span class="o">}</span>
  tags <span class="o">{</span>
    Name <span class="o">=</span> <span class="s2">"swarm_sg"</span>
  <span class="o">}</span>
<span class="o">}</span>

<span class="c">##Find latest Ubuntu 16.04 AMI</span>
data <span class="s2">"aws_ami"</span> <span class="s2">"ubuntu"</span> <span class="o">{</span>
  most_recent <span class="o">=</span> <span class="nb">true
  </span>filter <span class="o">{</span>
    name   <span class="o">=</span> <span class="s2">"name"</span>
    values <span class="o">=</span> <span class="o">[</span><span class="s2">"ubuntu/images/hvm-ssd/ubuntu-xenial-16.04-amd64-server-*"</span><span class="o">]</span>
  <span class="o">}</span>
  filter <span class="o">{</span>
    name   <span class="o">=</span> <span class="s2">"virtualization-type"</span>
    values <span class="o">=</span> <span class="o">[</span><span class="s2">"hvm"</span><span class="o">]</span>
  <span class="o">}</span>
  owners <span class="o">=</span> <span class="o">[</span><span class="s2">"099720109477"</span><span class="o">]</span> <span class="c"># Canonical</span>
<span class="o">}</span>

<span class="c">##Create Swarm Master Instance</span>
resource <span class="s2">"aws_instance"</span> <span class="s2">"swarm-master"</span> <span class="o">{</span>
  depends_on             <span class="o">=</span> <span class="o">[</span><span class="s2">"aws_security_group.swarm_sg"</span><span class="o">]</span>
  ami                    <span class="o">=</span> <span class="s2">"</span><span class="k">${</span><span class="nv">data</span><span class="p">.aws_ami.ubuntu.id</span><span class="k">}</span><span class="s2">"</span>
  instance_type          <span class="o">=</span> <span class="s2">"</span><span class="k">${</span><span class="nv">var</span><span class="p">.aws_instance_size</span><span class="k">}</span><span class="s2">"</span>
  vpc_security_group_ids <span class="o">=</span> <span class="o">[</span><span class="s2">"</span><span class="k">${</span><span class="nv">aws_security_group</span><span class="p">.swarm_sg.id</span><span class="k">}</span><span class="s2">"</span><span class="o">]</span>
  key_name               <span class="o">=</span> <span class="s2">"</span><span class="k">${</span><span class="nv">var</span><span class="p">.aws_key_name</span><span class="k">}</span><span class="s2">"</span>
  tags <span class="o">{</span>
    Name <span class="o">=</span> <span class="s2">"swarm-master"</span>
  <span class="o">}</span>
<span class="o">}</span>

<span class="c">##Create AWS Swarm Workers</span>
resource <span class="s2">"aws_instance"</span> <span class="s2">"aws-swarm-members"</span> <span class="o">{</span>
  depends_on             <span class="o">=</span> <span class="o">[</span><span class="s2">"aws_security_group.swarm_sg"</span><span class="o">]</span>
  ami                    <span class="o">=</span> <span class="s2">"</span><span class="k">${</span><span class="nv">data</span><span class="p">.aws_ami.ubuntu.id</span><span class="k">}</span><span class="s2">"</span>
  instance_type          <span class="o">=</span> <span class="s2">"</span><span class="k">${</span><span class="nv">var</span><span class="p">.aws_instance_size</span><span class="k">}</span><span class="s2">"</span>
  vpc_security_group_ids <span class="o">=</span> <span class="o">[</span><span class="s2">"</span><span class="k">${</span><span class="nv">aws_security_group</span><span class="p">.swarm_sg.id</span><span class="k">}</span><span class="s2">"</span><span class="o">]</span>
  key_name               <span class="o">=</span> <span class="s2">"</span><span class="k">${</span><span class="nv">var</span><span class="p">.aws_key_name</span><span class="k">}</span><span class="s2">"</span>
  count                  <span class="o">=</span> <span class="s2">"</span><span class="k">${</span><span class="nv">var</span><span class="p">.aws_worker_count</span><span class="k">}</span><span class="s2">"</span>
  tags <span class="o">{</span>
    Name <span class="o">=</span> <span class="s2">"swarm-member-</span><span class="k">${</span><span class="nv">count</span><span class="p">.index</span><span class="k">}</span><span class="s2">"</span>
  <span class="o">}</span>
<span class="o">}</span></code></pre></figure>

<p>Walking through this file, we can see a few things happen. If you’ve seen Terraform scripts before it’s pretty straight forward.</p>
<ul>
  <li>First, we simply configure a bit of info to tell Terraform to talk to our desired region that’s specified in the variables file.</li>
  <li>Next, we create a security group called <code class="highlighter-rouge">swarm_sg</code>. This security group allows ingress from all of the ports listed <a href="https://docs.docker.com/engine/swarm/swarm-tutorial/#open-ports-between-the-hosts">here</a>.</li>
  <li>Finally, we’ll create all of the nodes that we plan to use in AWS. We’ll create the master instance first, simply because it’s tagged differently, then we’ll create the workers. Notice the use of <code class="highlighter-rouge">${var...</code> everywhere. This is how variables are passed from the vars file into the desired configuration of our nodes.</li>
</ul>

<p>It’s now time to create our GCE infrastructure.</p>

<ul>
  <li>Open <code class="highlighter-rouge">01-gce-infra.tf</code> and paste the following:</li>
</ul>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="c">##Google Infrastructure</span>
provider <span class="s2">"google"</span> <span class="o">{</span>
  credentials <span class="o">=</span> <span class="s2">"</span><span class="k">${</span><span class="nv">file</span><span class="p">(</span><span class="s2">"</span><span class="k">${</span><span class="nv">var</span><span class="p">.gce_creds_path</span><span class="k">}</span><span class="s2">"</span><span class="p">)</span><span class="k">}</span><span class="s2">"</span>
  project     <span class="o">=</span> <span class="s2">"</span><span class="k">${</span><span class="nv">var</span><span class="p">.gce_project</span><span class="k">}</span><span class="s2">"</span>
  region      <span class="o">=</span> <span class="s2">"</span><span class="k">${</span><span class="nv">var</span><span class="p">.gce_region</span><span class="k">}</span><span class="s2">"</span>
<span class="o">}</span>

<span class="c">##Create Swarm Firewall Rules</span>
resource <span class="s2">"google_compute_firewall"</span> <span class="s2">"swarm_sg"</span> <span class="o">{</span>
  name    <span class="o">=</span> <span class="s2">"swarm-sg"</span>
  network <span class="o">=</span> <span class="s2">"default"</span>

  allow <span class="o">{</span>
    protocol <span class="o">=</span> <span class="s2">"udp"</span>
    ports    <span class="o">=</span> <span class="o">[</span><span class="s2">"7946"</span><span class="o">]</span>
  <span class="o">}</span>

  allow <span class="o">{</span>
    protocol <span class="o">=</span> <span class="s2">"tcp"</span>
    ports    <span class="o">=</span> <span class="o">[</span><span class="s2">"22"</span>, <span class="s2">"2377"</span>, <span class="s2">"7946"</span>, <span class="s2">"4789"</span><span class="o">]</span>
  <span class="o">}</span>
<span class="o">}</span>

<span class="c">##Create GCE Swarm Members</span>
resource <span class="s2">"google_compute_instance"</span> <span class="s2">"gce-swarm-members"</span> <span class="o">{</span>
  depends_on   <span class="o">=</span> <span class="o">[</span><span class="s2">"google_compute_firewall.swarm_sg"</span><span class="o">]</span>
  name         <span class="o">=</span> <span class="s2">"swarm-member-</span><span class="k">${</span><span class="nv">count</span><span class="p">.index</span><span class="k">}</span><span class="s2">"</span>
  machine_type <span class="o">=</span> <span class="s2">"</span><span class="k">${</span><span class="nv">var</span><span class="p">.gce_instance_size</span><span class="k">}</span><span class="s2">"</span>
  zone         <span class="o">=</span> <span class="s2">"</span><span class="k">${</span><span class="nv">var</span><span class="p">.gce_region</span><span class="k">}</span><span class="s2">-a"</span>
  count        <span class="o">=</span> <span class="s2">"</span><span class="k">${</span><span class="nv">var</span><span class="p">.gce_worker_count</span><span class="k">}</span><span class="s2">"</span>

  disk <span class="o">{</span>
    image <span class="o">=</span> <span class="s2">"ubuntu-os-cloud/ubuntu-1604-lts"</span>
  <span class="o">}</span>

  disk <span class="o">{</span>
    <span class="nb">type</span>    <span class="o">=</span> <span class="s2">"local-ssd"</span>
    scratch <span class="o">=</span> <span class="nb">true</span>
  <span class="o">}</span>

  network_interface <span class="o">{</span>
    network       <span class="o">=</span> <span class="s2">"default"</span>
    access_config <span class="o">=</span> <span class="o">{}</span>
  <span class="o">}</span>

  metadata <span class="o">{</span>
    ssh-keys <span class="o">=</span> <span class="s2">"ubuntu:</span><span class="k">${</span><span class="nv">file</span><span class="p">(</span><span class="s2">"</span><span class="k">${</span><span class="nv">var</span><span class="p">.public_key_path</span><span class="k">}</span><span class="s2">"</span><span class="p">)</span><span class="k">}</span><span class="s2">"</span>
  <span class="o">}</span>
<span class="o">}</span></code></pre></figure>

<p>Taking a read through this file, you’ll notice we’re essentially doing the same thing we did with AWS:</p>
<ul>
  <li>Configure some basic info to connect to GCE.</li>
  <li>Create firewall rules in the default network to allow ingresses for Swarm.</li>
  <li>Create the Swarm members in GCE.</li>
</ul>

<p>We’re almost done with Terraform! The last bit is we need to take the infrastructure that gets created and create an inventory file that Ansible can use to provision the actual Docker bits.</p>

<ul>
  <li>Populate <code class="highlighter-rouge">02-create-inv.tf</code>:</li>
</ul>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">resource <span class="s2">"null_resource"</span> <span class="s2">"ansible-provision"</span> <span class="o">{</span>
  depends_on <span class="o">=</span> <span class="o">[</span><span class="s2">"aws_instance.swarm-master"</span>, <span class="s2">"aws_instance.aws-swarm-members"</span>, <span class="s2">"google_compute_instance.gce-swarm-members"</span><span class="o">]</span>

  provisioner <span class="s2">"local-exec"</span> <span class="o">{</span>
    <span class="nb">command</span> <span class="o">=</span> <span class="s2">"echo </span><span class="se">\"</span><span class="s2">[swarm-master]</span><span class="se">\"</span><span class="s2"> &gt; swarm-inventory"</span>
  <span class="o">}</span>

  provisioner <span class="s2">"local-exec"</span> <span class="o">{</span>
    <span class="nb">command</span> <span class="o">=</span> <span class="s2">"echo </span><span class="se">\"</span><span class="k">${</span><span class="nv">format</span><span class="p">(</span><span class="s2">"%s ansible_ssh_user=%s"</span><span class="p">, aws_instance.swarm-master.0.public_ip, var.ssh_user)</span><span class="k">}</span><span class="se">\"</span><span class="s2"> &gt;&gt; swarm-inventory"</span>
  <span class="o">}</span>

  provisioner <span class="s2">"local-exec"</span> <span class="o">{</span>
    <span class="nb">command</span> <span class="o">=</span> <span class="s2">"echo </span><span class="se">\"</span><span class="s2">[swarm-nodes]</span><span class="se">\"</span><span class="s2"> &gt;&gt; swarm-inventory"</span>
  <span class="o">}</span>

  provisioner <span class="s2">"local-exec"</span> <span class="o">{</span>
    <span class="nb">command</span> <span class="o">=</span> <span class="s2">"echo </span><span class="se">\"</span><span class="k">${</span><span class="nv">join</span><span class="p">(</span><span class="s2">"</span><span class="se">\n</span><span class="s2">"</span><span class="p">,formatlist(</span><span class="s2">"%s ansible_ssh_user=%s"</span><span class="p">, aws_instance.aws-swarm-members.*.public_ip, var.ssh_user))</span><span class="k">}</span><span class="se">\"</span><span class="s2"> &gt;&gt; swarm-inventory"</span>
  <span class="o">}</span>

  provisioner <span class="s2">"local-exec"</span> <span class="o">{</span>
    <span class="nb">command</span> <span class="o">=</span> <span class="s2">"echo </span><span class="se">\"</span><span class="k">${</span><span class="nv">join</span><span class="p">(</span><span class="s2">"</span><span class="se">\n</span><span class="s2">"</span><span class="p">,formatlist(</span><span class="s2">"%s ansible_ssh_user=%s"</span><span class="p">, google_compute_instance.gce-swarm-members.*.network_interface.0.access_config.0.assigned_nat_ip, var.ssh_user))</span><span class="k">}</span><span class="se">\"</span><span class="s2"> &gt;&gt; swarm-inventory"</span>
  <span class="o">}</span>
<span class="o">}</span>
 </code></pre></figure>

<p>This file simply tells Terraform, after all infrastructure has been created, to drop a file locally called <code class="highlighter-rouge">swarm-inventory</code>. The file that’s dropped should look like (real IPs redacted):</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="o">[</span>swarm-master]
aaa.bbb.ccc.ddd <span class="nv">ansible_ssh_user</span><span class="o">=</span>ubuntu
<span class="o">[</span>swarm-nodes]
eee.fff.ggg.hhh <span class="nv">ansible_ssh_user</span><span class="o">=</span>ubuntu
iii.jjj.kkk.lll <span class="nv">ansible_ssh_user</span><span class="o">=</span>ubuntu</code></pre></figure>

<h2 id="ansible-time"><strong>Ansible Time!</strong></h2>

<p>Okay, now that we’ve got the Terraform bits ready to deploy the infrastructure, we need to be able to actually bootstrap the cluster once the nodes are online. We’ll create two files here: <code class="highlighter-rouge">swarm.yml</code> and <code class="highlighter-rouge">swarm-destroy.yml</code>.</p>

<ul>
  <li>Create <code class="highlighter-rouge">swarm.yml</code> with:</li>
</ul>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="o">-</span> <span class="ss">name: </span><span class="no">Install</span> <span class="no">Ansible</span> <span class="no">Prereqs</span>
  <span class="ss">hosts: </span><span class="n">swarm</span><span class="o">-</span><span class="n">master</span><span class="ss">:swarm</span><span class="o">-</span><span class="n">nodes</span>
  <span class="ss">gather_facts: </span><span class="n">no</span>
  <span class="ss">tasks:
    </span><span class="o">-</span> <span class="ss">raw: </span><span class="s2">"apt-get update &amp;&amp; DEBIAN_FRONTEND=noninteractive apt-get install -y python-minimal python-pip"</span>

<span class="o">-</span> <span class="ss">name: </span><span class="no">Install</span> <span class="no">Docker</span> <span class="no">Prereqs</span>
  <span class="ss">hosts: </span><span class="n">swarm</span><span class="o">-</span><span class="n">master</span><span class="ss">:swarm</span><span class="o">-</span><span class="n">nodes</span>
  <span class="ss">gather_facts: </span><span class="n">yes</span>
  <span class="ss">tasks:
    </span><span class="o">-</span> <span class="ss">package:
        name: </span><span class="s2">"{{item}}"</span>
        <span class="ss">state: </span><span class="n">latest</span>
      <span class="ss">with_items:
        </span><span class="o">-</span> <span class="n">apt</span><span class="o">-</span><span class="n">transport</span><span class="o">-</span><span class="n">https</span>
        <span class="o">-</span> <span class="n">ca</span><span class="o">-</span><span class="n">certificates</span>
        <span class="o">-</span> <span class="n">curl</span>
        <span class="o">-</span> <span class="n">software</span><span class="o">-</span><span class="n">properties</span><span class="o">-</span><span class="n">common</span>
    <span class="o">-</span> <span class="ss">apt_key:
        url: </span><span class="s2">"https://download.docker.com/linux/ubuntu/gpg"</span>
        <span class="ss">state: </span><span class="n">present</span>
    <span class="o">-</span> <span class="ss">apt_repository:
        repo: </span><span class="s2">"deb [arch=amd64] https://download.docker.com/linux/ubuntu xenial stable"</span>
        <span class="ss">state: </span><span class="n">present</span>

<span class="o">-</span> <span class="ss">name: </span><span class="no">Install</span> <span class="no">Docker</span>
  <span class="ss">hosts: </span><span class="n">swarm</span><span class="o">-</span><span class="n">master</span><span class="ss">:swarm</span><span class="o">-</span><span class="n">nodes</span>
  <span class="ss">gather_facts: </span><span class="n">yes</span>
  <span class="ss">tasks:
    </span><span class="o">-</span> <span class="ss">package:
        name: </span><span class="s2">"docker-ce"</span>
        <span class="ss">state: </span><span class="n">latest</span>
    <span class="o">-</span> <span class="ss">user: 
        name: </span><span class="s2">"{{ ansible_ssh_user }}"</span>
        <span class="ss">groups: </span><span class="n">docker</span>
        <span class="ss">append: </span><span class="n">yes</span>

<span class="o">-</span> <span class="ss">name: </span><span class="no">Initialize</span> <span class="no">Swarm</span> <span class="no">Master</span>
  <span class="ss">hosts: </span><span class="n">swarm</span><span class="o">-</span><span class="n">master</span>
  <span class="ss">gather_facts: </span><span class="n">yes</span>
  <span class="ss">tasks:
    </span><span class="o">-</span> <span class="ss">command: </span><span class="s2">"docker swarm init --advertise-addr {{inventory_hostname}}"</span>
    <span class="o">-</span> <span class="ss">command: </span><span class="s2">"docker swarm join-token -q worker"</span>
      <span class="ss">register: </span><span class="n">swarm_token</span>
    <span class="o">-</span> <span class="ss">set_fact: </span><span class="n">swarmtoken</span><span class="o">=</span><span class="s2">"{{swarm_token.stdout}}"</span>
  
<span class="o">-</span> <span class="ss">name: </span><span class="no">Join</span> <span class="no">Swarm</span> <span class="no">Nodes</span>
  <span class="ss">hosts: </span><span class="n">swarm</span><span class="o">-</span><span class="n">nodes</span>
  <span class="ss">gather_facts: </span><span class="n">yes</span>
  <span class="ss">tasks:
  </span><span class="o">-</span> <span class="ss">command: </span><span class="s2">"docker swarm join --advertise-addr {{inventory_hostname}} --token {{hostvars[groups['swarm-master'][0]].swarmtoken}} {{hostvars[groups['swarm-master'][0]].inventory_hostname}}:2377"</span></code></pre></figure>

<p>This Ansible playbook does a few things:</p>
<ul>
  <li>Bootstraps all nodes with the necessary packages for Ansible to run properly.</li>
  <li>Installs Docker prerequisites and then installs Docker.</li>
  <li>On the master, initializes the swarm and grabs the key necessary to join.</li>
  <li>On the nodes, simply joins the swarm.</li>
</ul>

<p>Now, that’s really all we need. But while we’re here, let’s make sure we can tear our Swarm down as well.</p>
<ul>
  <li>Create <code class="highlighter-rouge">swarm-destroy.yml</code>:</li>
</ul>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="o">-</span> <span class="ss">name: </span><span class="no">Leave</span> <span class="no">Swarm</span>
  <span class="ss">hosts: </span><span class="n">swarm</span><span class="o">-</span><span class="n">master</span><span class="ss">:swarm</span><span class="o">-</span><span class="n">nodes</span>
  <span class="ss">gather_facts: </span><span class="n">yes</span>
  <span class="ss">tasks:
    </span><span class="o">-</span> <span class="ss">command: </span><span class="s2">"docker swarm leave --force"</span></code></pre></figure>

<p>That one’s really easy. It really just goes to each node and tells it to leave the Swarm, no questions asked.</p>

<h2 id="create-swarm"><strong>Create Swarm</strong></h2>

<p>Okay, now that we’ve got all the bits in place, let’s create our swarm.</p>
<ul>
  <li>First source AWS API keys with <code class="highlighter-rouge">source /path/to/awscreds.sh</code> or <code class="highlighter-rouge">export ...</code>.</li>
  <li>Create the infrastructure with <code class="highlighter-rouge">terraform apply</code>. Keep in mind that you may also want to pass in the <code class="highlighter-rouge">-var</code> flag to override defaults.</li>
  <li>Once built, issue <code class="highlighter-rouge">cat swarm-inventory</code> to ensure master and workers are populated.</li>
  <li>Bootstrap the Swarm cluster with <code class="highlighter-rouge">ANSIBLE_HOST_KEY_CHECKING=False ansible-playbook -b -i swarm-inventory swarm.yml</code>.</li>
</ul>

<p>In the just a couple of minutes, these steps should have been completed successfully. If all looks like it went okay, SSH into the master node.</p>

<ul>
  <li>Issue <code class="highlighter-rouge">docker node ls</code> and view all the nodes in the Swarm. You’ll notice different hostnames between AWS and GCE instances:</li>
</ul>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="gp">ubuntu@ip-172-31-5-8:~$ </span>docker node ls
ID                           HOSTNAME         STATUS  AVAILABILITY  MANAGER STATUS
mei9ysylvokq6foczu7ygwso6 <span class="k">*</span>  ip-172-31-5-8    Ready   Active        Leader
tzsdybhx5f9c8qv2z55ry2me4    swarm-member-0   Ready   Active
vzxbjpus3t8ufm0j0z7rmzn18    ip-172-31-6-146  Ready   Active</code></pre></figure>

<h2 id="test-it-out"><strong>Test It Out</strong></h2>
<p>Now that we’ve got our Swarm up, let’s create a scaled service and we’ll see it show up on different environments.</p>

<ul>
  <li>Issue <code class="highlighter-rouge">docker service create --replicas 5 --name helloworld alpine ping google.com</code> on the master.</li>
  <li>Find where the pods are scheduled with <code class="highlighter-rouge">docker service ps helloworld</code>:</li>
</ul>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="gp">ubuntu@ip-172-31-5-8:~$ </span>docker service ps helloworld
ID            NAME          IMAGE          NODE             DESIRED STATE  CURRENT STATE              ERROR  PORTS
6ifn97x0lcor  helloworld.1  alpine:latest  swarm-member-0   Running        Running about an hour ago
fmfgkurl99j5  helloworld.2  alpine:latest  swarm-member-0   Running        Running about an hour ago
2et88afaxfky  helloworld.3  alpine:latest  ip-172-31-6-146  Running        Running about an hour ago
jbobdjkk062h  helloworld.4  alpine:latest  ip-172-31-5-8    Running        Running about an hour ago
j9nkx5lqr82x  helloworld.5  alpine:latest  ip-172-31-5-8    Running        Running about an hour ago</code></pre></figure>

<ul>
  <li>SSH into the GCE worker and find the containers running there with <code class="highlighter-rouge">docker ps</code>.</li>
  <li>Show that the containers are pinging Google as expected with <code class="highlighter-rouge">docker logs &lt;CONTAINER_ID&gt;</code></li>
  <li>Do the same with the AWS nodes.</li>
</ul>

<h2 id="teardown"><strong>Teardown</strong></h2>
<p>Once we’re done with our test cluster it’s time to trash it.</p>
<ul>
  <li>You can tear down just the Swarm, while leaving the infrastructure with <code class="highlighter-rouge">ANSIBLE_HOST_KEY_CHECKING=False ansible-playbook -b -i swarm-inventory swarm-destroy.yml</code></li>
  <li>Tear down all the things with a simple <code class="highlighter-rouge">terraform destroy</code></li>
</ul>

<p>That’s it! I was happy to get a cross-cloud Swarm running pretty quickly. Over the next few weeks, I’ll probably come back to revisit my Swarm deployment and make sure some of the more interesting things are possible, like creating networks and scheduling webservers. Stay tuned!</p>

  </div><!-- /.entry-content -->
</article><!-- /.hentry -->

<article class="hentry">
  <header>
    
    <div class="entry-meta">
      <span class="entry-date date published updated"><time datetime="2017-03-04T00:00:00-05:00"><a href="https://rsmitty.github.io/CoreOS-CloudWatch-Metrics/">March 04, 2017</a></time></span><span class="author vcard"><span class="fn"><a href="https://rsmitty.github.io/about/" title="About Spencer Smith">Spencer Smith</a></span></span>
      
      <span class="entry-reading-time">
        <i class="fa fa-clock-o"></i>
        
Reading time ~2 minutes
      </span><!-- /.entry-reading-time -->
      
    </div><!-- /.entry-meta -->
    
      <h1 class="entry-title"><a href="https://rsmitty.github.io/CoreOS-CloudWatch-Metrics/" rel="bookmark" title="Reporting to CloudWatch from CoreOS" itemprop="url">Reporting to CloudWatch from CoreOS</a></h1>
    
  </header>
  <div class="entry-content">
    <p>Wanted to drop a quick how-to on how to report back up to CloudWatch from a CoreOS instance in Amazon. This is a bit of a lab project, something I was thinking about and decided to try. Fair warning that I haven’t used this with any serious workloads or anything.</p>

<p>If you’ve never used it before, CloudWatch is an AWS service that allows you to gather metrics and trigger alarms based on those metrics. This is core to having a robust architecture in Amazon and being able to scale instances in your autoscaling groups. By default, only hypervisor level data is available to act upon: CPU %, Network I/O, or Disk I/O. In order to get some other actionable metrics like disk and RAM usage, we want to make use of the CloudWatch Monitoring Scripts found <a href="https://aws.amazon.com/code/8720044071969977">here</a>.</p>

<h2 id="containerize-custom-metrics"><strong>Containerize Custom Metrics</strong></h2>

<p>Let’s bundle all the necessary bits we need to report up to CloudWatch inside of a container image. That is the CoreOS way after all!</p>

<ul>
  <li>Create two files, <code class="highlighter-rouge">Dockerfile</code> and <code class="highlighter-rouge">entrypoint.sh</code></li>
  <li>Open <code class="highlighter-rouge">Dockerfile</code> for editing:</li>
</ul>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">FROM alpine:3.5

<span class="c">##Install perl packages and pull CloudWatch scripts</span>
RUN apk add --no-cache perl-libwww perl-datetime
RUN wget http://aws-cloudwatch.s3.amazonaws.com/downloads/CloudWatchMonitoringScripts-1.2.1.zip <span class="o">&amp;&amp;</span> <span class="se">\</span>
    unzip CloudWatchMonitoringScripts-1.2.1.zip <span class="o">&amp;&amp;</span> <span class="se">\</span>
    rm CloudWatchMonitoringScripts-1.2.1.zip
WORKDIR aws-scripts-mon

<span class="c">##Copy entrypoint and make it executable</span>
COPY entrypoint.sh entrypoint.sh
RUN chmod +x entrypoint.sh

<span class="c">##Simply run entrypoint</span>
CMD ./entrypoint.sh</code></pre></figure>

<ul>
  <li>And now <code class="highlighter-rouge">entrypoint.sh</code>:</li>
</ul>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="c">#!/bin/sh</span>
<span class="k">while </span><span class="nb">true</span>; <span class="k">do</span>
  ./mon-put-instance-data.pl --mem-util --mem-used --mem-avail <span class="se">\</span>
  --disk-space-avail --disk-space-used --disk-space-util --disk-path<span class="o">=</span>/rootfs <span class="se">\</span>
  --aws-access-key-id <span class="nv">$AWS_ACCESS_KEY_ID</span> --aws-secret-key <span class="nv">$AWS_SECRET_ACCESS_KEY</span>
  sleep 60
<span class="k">done</span></code></pre></figure>

<ul>
  <li>In the bash script, let’s note that the disk-path we’re pointing to is /rootfs. I couldn’t find a great consensus on whether the value reported inside the container a <code class="highlighter-rouge">/</code> was accurate since it points to the overlay. We’ll work around this by mounting the <code class="highlighter-rouge">/</code> directory from the host as read only.</li>
</ul>

<h2 id="test-it"><strong>Test It</strong></h2>

<p>We can see if our container works simply by building and running.</p>

<p>On a CoreOS VM in AWS:</p>
<ul>
  <li><code class="highlighter-rouge">docker build -t cloudwatch-mon .</code> (In the same directory as the Dockerfile and entrypoint.sh script)</li>
  <li>Run the container, filling in the AWS credentials as needed.
<code class="highlighter-rouge">docker run -ti -e AWS_ACCESS_KEY_ID="abc" \</code>
<code class="highlighter-rouge">-e AWS_SECRET_ACCESS_KEY="123" -v /:/rootfs:ro cloudwatch-mon</code></li>
</ul>

<p>You should see some output that shows that it’s sending data to CloudWatch:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">core@ip-172-31-17-23 ~ <span class="nv">$ </span>docker run -ti -e <span class="nv">AWS_ACCESS_KEY_ID</span><span class="o">=</span><span class="s2">"aaabbbccc"</span> -e <span class="nv">AWS_SECRET_ACCESS_KEY</span><span class="o">=</span><span class="s2">"111222333"</span> -v /:/rootfs:ro cloudwatch-mon

Successfully reported metrics to CloudWatch. Reference Id: 123-00cc-11e7-b3bc-abc


Successfully reported metrics to CloudWatch. Reference Id: 123-00cc-11e7-b3bc-abc


Successfully reported metrics to CloudWatch. Reference Id: 123-00cc-11e7-b3bc-abc
...</code></pre></figure>

<ul>
  <li>At this point we can push it to the Docker hub so that we can pull it down on other hosts as well.</li>
</ul>

<h2 id="wrap-it-up"><strong>Wrap It Up</strong></h2>

<p>Now that we’ve got a working Docker image, we can wrap it in a systemd service definition. Note that the same service setup could be added to cloud-config and automatically configured for new hosts.</p>

<ul>
  <li>Create a credentials file at <code class="highlighter-rouge">/root/.aws/creds</code>. It should look something like:</li>
</ul>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">AWS_ACCESS_KEY_ID</span><span class="o">=</span><span class="s2">"aaabbbccc"</span>
<span class="nv">AWS_SECRET_ACCESS_KEY</span><span class="o">=</span><span class="s2">"111222333"</span></code></pre></figure>

<ul>
  <li>Now create a service file at <code class="highlighter-rouge">/etc/systemd/system/cloudwatch.service</code>. Populate it with:</li>
</ul>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="o">[</span>Unit]
<span class="nv">Description</span><span class="o">=</span>cloudwatch docker wrapper
<span class="nv">Wants</span><span class="o">=</span>docker.socket
<span class="nv">After</span><span class="o">=</span>docker.service

<span class="o">[</span>Service]
<span class="nv">EnvironmentFile</span><span class="o">=</span>/root/.aws/creds
<span class="nv">User</span><span class="o">=</span>root
<span class="nv">PermissionsStartOnly</span><span class="o">=</span><span class="nb">true
</span><span class="nv">ExecStart</span><span class="o">=</span>/usr/bin/docker run -e <span class="nv">AWS_ACCESS_KEY_ID</span><span class="o">=</span><span class="k">${</span><span class="nv">AWS_ACCESS_KEY_ID</span><span class="k">}</span> <span class="se">\</span>
-e <span class="nv">AWS_SECRET_ACCESS_KEY</span><span class="o">=</span><span class="k">${</span><span class="nv">AWS_SECRET_ACCESS_KEY</span><span class="k">}</span> <span class="se">\</span>
-v /:/rootfs:ro --name<span class="o">=</span>cloudwatch-mon cloudwatch-mon
<span class="nv">ExecStartPre</span><span class="o">=</span>-/usr/bin/docker rm -f cloudwatch-mon
<span class="nv">ExecReload</span><span class="o">=</span>/usr/bin/docker restart cloudwatch-mon
<span class="nv">ExecStop</span><span class="o">=</span>/usr/bin/docker stop cloudwatch-mon
<span class="nv">Restart</span><span class="o">=</span>always
<span class="nv">RestartSec</span><span class="o">=</span>15s

<span class="o">[</span>Install]
<span class="nv">WantedBy</span><span class="o">=</span>multi-user.target</code></pre></figure>

<ul>
  <li>Issue <code class="highlighter-rouge">sudo systemctl daemon-reload</code></li>
  <li>Start the monitoring service with <code class="highlighter-rouge">sudo systemctl start cloudwatch</code></li>
  <li>You should see that it’s reporting upstream with <code class="highlighter-rouge">sudo systemctl status cloudwatch</code></li>
  <li>Finally, you can head to the CloudWatch dashboard. The link should look something like: <code class="highlighter-rouge">https://us-west-2.console.aws.amazon.com/cloudwatch/home?region=us-west-2</code></li>
  <li>Once there, you should see metrics under “Linux System” that show the disk and RAM usage.</li>
  <li>You can also create some dashboards. Here’s what I was able to quickly mock up:
<a href="/img/posts/2017-03-04-CoreOS-CloudWatch-Metrics/cloudwatch-dash.png">
<img src="/img/posts/2017-03-04-CoreOS-CloudWatch-Metrics/cloudwatch-dash.png" style="max-width:80%; border:solid 1px;" /></a></li>
</ul>

  </div><!-- /.entry-content -->
</article><!-- /.hentry -->

<article class="hentry">
  <header>
    
    <div class="entry-meta">
      <span class="entry-date date published updated"><time datetime="2017-03-03T00:00:00-05:00"><a href="https://rsmitty.github.io/Slack-Bot-Image-Search/">March 03, 2017</a></time></span><span class="author vcard"><span class="fn"><a href="https://rsmitty.github.io/about/" title="About Spencer Smith">Spencer Smith</a></span></span>
      
      <span class="entry-reading-time">
        <i class="fa fa-clock-o"></i>
        
Reading time ~5 minutes
      </span><!-- /.entry-reading-time -->
      
    </div><!-- /.entry-meta -->
    
      <h1 class="entry-title"><a href="https://rsmitty.github.io/Slack-Bot-Image-Search/" rel="bookmark" title="Extending Our Slack Bot with Image Search" itemprop="url">Extending Our Slack Bot with Image Search</a></h1>
    
  </header>
  <div class="entry-content">
    <p>As a follow-up to <a href="https://rsmitty.github.io/Slack-Bot/">yesterday’s post</a>, I wanted to talk about how I built “baconator” at Solinea. This is a goofy Slack bot that we run internally. He responds to requests by querying Google Images for pictures of bacon and then posts them in the channel. Here’s how I did it:</p>

<h2 id="get-the-proper-googly-bits"><strong>Get the Proper Googly Bits</strong></h2>

<h4 id="setup-custom-search"><strong>Setup Custom Search</strong></h4>
<p>To get access to Google Images, we need to create a custom search. This gives us some keys and info we need to pass later on.</p>

<ul>
  <li>Head to the <a href="https://cse.google.com/cse/">CSE main page</a>.</li>
  <li>Click “Create A Custom Search Engine”</li>
  <li>Fill out the search website by entering “www.google.com”</li>
  <li>
    <p>Give a name. I called mine “Google Custom Searcher”
<a href="/img/posts/2017-03-03-Slack-Bot-Image-Search/cse-creation.png">
<img src="/img/posts/2017-03-03-Slack-Bot-Image-Search/cse-creation.png" style="max-width:75%; border:solid 1px;" /></a></p>
  </li>
  <li>Once created, hit the “Public URL” button.</li>
  <li>Take a look at the search bar in the browser and copy the “cx” portion. We’ll use it later.
<a href="/img/posts/2017-03-03-Slack-Bot-Image-Search/cx-info.png">
<img src="/img/posts/2017-03-03-Slack-Bot-Image-Search/cx-info.png" style="max-width:75%; border:solid 1px;" /></a></li>
</ul>

<h4 id="setup-an-api-key"><strong>Setup an API Key</strong></h4>
<p>Once that’s done, we now have to create an API key. I believe you have to have a Google Cloud project already created, so this may involve a couple of steps.</p>
<ul>
  <li>Go to the Google developers console’s <a href="https://console.developers.google.com/iam-admin/projects">project page</a>.</li>
  <li>Add a new project with a name of your choosing.</li>
  <li>Head to the credentials page for your project. This should be a url like <code class="highlighter-rouge">https://console.developers.google.com/apis/credentials?project=$YOUR_PROJECT_NAME</code></li>
  <li>Once there, you’ll generate a new API key with “Create Credentials -&gt; API Key”.</li>
  <li>Copy down the API key, we’ll need it as well.</li>
</ul>

<p>Phew, now we actually have the bits we need! Let’s get the code together.</p>

<h2 id="update-the-code"><strong>Update the Code</strong></h2>

<h4 id="respond-function"><strong>Respond Function</strong></h4>
<p>First, we want to turn to our <code class="highlighter-rouge">respond</code> function that we created last time. What we want to do first is update our accepted phrases to be bacon related, as well as reach out to our next function, <code class="highlighter-rouge">receiveBacon</code>. This function will be the one that queries our custom search.</p>

<ul>
  <li>Update <code class="highlighter-rouge">respond</code> to look like the following:</li>
</ul>

<figure class="highlight"><pre><code class="language-go" data-lang="go"><span class="k">func</span><span class="x"> </span><span class="n">respond</span><span class="p">(</span><span class="n">rtm</span><span class="x"> </span><span class="o">*</span><span class="n">slack</span><span class="o">.</span><span class="n">RTM</span><span class="p">,</span><span class="x"> </span><span class="n">msg</span><span class="x"> </span><span class="o">*</span><span class="n">slack</span><span class="o">.</span><span class="n">MessageEvent</span><span class="p">,</span><span class="x"> </span><span class="n">prefix</span><span class="x"> </span><span class="kt">string</span><span class="p">)</span><span class="x"> </span><span class="p">{</span><span class="x">
	</span><span class="k">var</span><span class="x"> </span><span class="n">response</span><span class="x"> </span><span class="kt">string</span><span class="x">
	</span><span class="n">text</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="n">msg</span><span class="o">.</span><span class="n">Text</span><span class="x">
	</span><span class="n">text</span><span class="x"> </span><span class="o">=</span><span class="x"> </span><span class="n">strings</span><span class="o">.</span><span class="n">TrimPrefix</span><span class="p">(</span><span class="n">text</span><span class="p">,</span><span class="x"> </span><span class="n">prefix</span><span class="p">)</span><span class="x">
	</span><span class="n">text</span><span class="x"> </span><span class="o">=</span><span class="x"> </span><span class="n">strings</span><span class="o">.</span><span class="n">TrimSpace</span><span class="p">(</span><span class="n">text</span><span class="p">)</span><span class="x">
	</span><span class="n">text</span><span class="x"> </span><span class="o">=</span><span class="x"> </span><span class="n">strings</span><span class="o">.</span><span class="n">ToLower</span><span class="p">(</span><span class="n">text</span><span class="p">)</span><span class="x">

	</span><span class="n">acceptedPhrases</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="k">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kt">bool</span><span class="p">{</span><span class="x">
		</span><span class="s">"hook it up"</span><span class="o">:</span><span class="x">     </span><span class="no">true</span><span class="p">,</span><span class="x">
		</span><span class="s">"hit me"</span><span class="o">:</span><span class="x">         </span><span class="no">true</span><span class="p">,</span><span class="x">
		</span><span class="s">"bacon me"</span><span class="o">:</span><span class="x">       </span><span class="no">true</span><span class="p">,</span><span class="x">
		</span><span class="s">"no pork please"</span><span class="o">:</span><span class="x"> </span><span class="no">true</span><span class="p">,</span><span class="x">
	</span><span class="p">}</span><span class="x">

	</span><span class="k">if</span><span class="x"> </span><span class="n">acceptedPhrases</span><span class="p">[</span><span class="n">text</span><span class="p">]</span><span class="x"> </span><span class="p">{</span><span class="x">
		</span><span class="k">var</span><span class="x"> </span><span class="n">baconString</span><span class="x"> </span><span class="kt">string</span><span class="x">
		</span><span class="k">if</span><span class="x"> </span><span class="n">text</span><span class="x"> </span><span class="o">==</span><span class="x"> </span><span class="s">"no pork please"</span><span class="x"> </span><span class="p">{</span><span class="x">
			</span><span class="n">baconString</span><span class="x"> </span><span class="o">=</span><span class="x"> </span><span class="s">"beef+bacon"</span><span class="x">
		</span><span class="p">}</span><span class="x"> </span><span class="k">else</span><span class="x"> </span><span class="p">{</span><span class="x">
			</span><span class="n">baconString</span><span class="x"> </span><span class="o">=</span><span class="x"> </span><span class="s">"bacon"</span><span class="x">
		</span><span class="p">}</span><span class="x">
		</span><span class="n">response</span><span class="x"> </span><span class="o">=</span><span class="x"> </span><span class="n">receiveBacon</span><span class="p">(</span><span class="n">baconString</span><span class="p">)</span><span class="x">
		</span><span class="n">rtm</span><span class="o">.</span><span class="n">SendMessage</span><span class="p">(</span><span class="n">rtm</span><span class="o">.</span><span class="n">NewOutgoingMessage</span><span class="p">(</span><span class="n">response</span><span class="p">,</span><span class="x"> </span><span class="n">msg</span><span class="o">.</span><span class="n">Channel</span><span class="p">))</span><span class="x">
	</span><span class="p">}</span><span class="x">
</span><span class="p">}</span></code></pre></figure>

<ul>
  <li>Note that we’re setting a different search string if we encounter the “no pork please” input. Have to respect the varied diets at Solinea, so we search for “beef bacon” in that case :)</li>
</ul>

<h4 id="bring-home-the-bacon"><strong>Bring Home the Bacon</strong></h4>

<p>Now that we’ve got the respond function setup, let’s add our <code class="highlighter-rouge">receiveBacon</code> function. We’ll also create a <code class="highlighter-rouge">random</code> function that will simply return a number between a min and max. We’ll use this to make sure we’re seeing fresh bacon each time!</p>

<ul>
  <li>Add the two functions. They should look like this:</li>
</ul>

<figure class="highlight"><pre><code class="language-go" data-lang="go"><span class="k">func</span><span class="x"> </span><span class="n">random</span><span class="p">(</span><span class="n">min</span><span class="p">,</span><span class="x"> </span><span class="n">max</span><span class="x"> </span><span class="kt">int</span><span class="p">)</span><span class="x"> </span><span class="kt">int</span><span class="x"> </span><span class="p">{</span><span class="x">
	</span><span class="n">rand</span><span class="o">.</span><span class="n">Seed</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">Now</span><span class="p">()</span><span class="o">.</span><span class="n">Unix</span><span class="p">())</span><span class="x">
	</span><span class="k">return</span><span class="x"> </span><span class="n">rand</span><span class="o">.</span><span class="n">Intn</span><span class="p">(</span><span class="n">max</span><span class="o">-</span><span class="n">min</span><span class="p">)</span><span class="x"> </span><span class="o">+</span><span class="x"> </span><span class="n">min</span><span class="x">
</span><span class="p">}</span><span class="x">

</span><span class="k">func</span><span class="x"> </span><span class="n">receiveBacon</span><span class="p">(</span><span class="n">baconType</span><span class="x"> </span><span class="kt">string</span><span class="p">)</span><span class="x"> </span><span class="kt">string</span><span class="x"> </span><span class="p">{</span><span class="x">

	</span><span class="n">cxString</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="n">os</span><span class="o">.</span><span class="n">Getenv</span><span class="p">(</span><span class="s">"CX_STRING"</span><span class="p">)</span><span class="x">
	</span><span class="n">apiKey</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="n">os</span><span class="o">.</span><span class="n">Getenv</span><span class="p">(</span><span class="s">"API_KEY"</span><span class="p">)</span><span class="x">
	</span><span class="n">startNum</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="n">strconv</span><span class="o">.</span><span class="n">Itoa</span><span class="p">(</span><span class="n">random</span><span class="p">(</span><span class="m">1</span><span class="p">,</span><span class="x"> </span><span class="m">10</span><span class="p">))</span><span class="x">
	</span><span class="n">url</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="s">"https://www.googleapis.com/customsearch/v1?cx="</span><span class="x"> </span><span class="o">+</span><span class="x"> </span><span class="n">cxString</span><span class="x"> </span><span class="o">+</span><span class="x"> </span><span class="s">"&amp;key="</span><span class="x"> </span><span class="o">+</span><span class="x"> </span><span class="n">apiKey</span><span class="x"> </span><span class="o">+</span><span class="x"> </span><span class="s">"&amp;q="</span><span class="x"> </span><span class="o">+</span><span class="x"> </span><span class="n">baconType</span><span class="x"> </span><span class="o">+</span><span class="x"> </span><span class="s">"&amp;searchType=image&amp;safe=medium&amp;start="</span><span class="x"> </span><span class="o">+</span><span class="x"> </span><span class="n">startNum</span><span class="x">
	</span><span class="n">fmt</span><span class="o">.</span><span class="n">Printf</span><span class="p">(</span><span class="n">url</span><span class="p">)</span><span class="x">
	</span><span class="n">response</span><span class="p">,</span><span class="x"> </span><span class="n">err</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="n">http</span><span class="o">.</span><span class="n">Get</span><span class="p">(</span><span class="n">url</span><span class="p">)</span><span class="x">
	</span><span class="k">if</span><span class="x"> </span><span class="n">err</span><span class="x"> </span><span class="o">!=</span><span class="x"> </span><span class="no">nil</span><span class="x"> </span><span class="p">{</span><span class="x">
		</span><span class="n">log</span><span class="o">.</span><span class="n">Fatal</span><span class="p">(</span><span class="n">err</span><span class="p">)</span><span class="x">
	</span><span class="p">}</span><span class="x">

	</span><span class="k">defer</span><span class="x"> </span><span class="n">response</span><span class="o">.</span><span class="n">Body</span><span class="o">.</span><span class="n">Close</span><span class="p">()</span><span class="x">
	</span><span class="n">body</span><span class="p">,</span><span class="x"> </span><span class="n">err</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="n">ioutil</span><span class="o">.</span><span class="n">ReadAll</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">Body</span><span class="p">)</span><span class="x">
	</span><span class="k">if</span><span class="x"> </span><span class="n">err</span><span class="x"> </span><span class="o">!=</span><span class="x"> </span><span class="no">nil</span><span class="x"> </span><span class="p">{</span><span class="x">
		</span><span class="n">log</span><span class="o">.</span><span class="n">Fatal</span><span class="p">(</span><span class="n">err</span><span class="p">)</span><span class="x">
	</span><span class="p">}</span><span class="x">

	</span><span class="k">var</span><span class="x"> </span><span class="n">jsonData</span><span class="x"> </span><span class="k">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="k">interface</span><span class="p">{}</span><span class="x">
	</span><span class="k">if</span><span class="x"> </span><span class="n">err</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="n">json</span><span class="o">.</span><span class="n">Unmarshal</span><span class="p">(</span><span class="n">body</span><span class="p">,</span><span class="x"> </span><span class="o">&amp;</span><span class="n">jsonData</span><span class="p">);</span><span class="x"> </span><span class="n">err</span><span class="x"> </span><span class="o">!=</span><span class="x"> </span><span class="no">nil</span><span class="x"> </span><span class="p">{</span><span class="x">
		</span><span class="n">log</span><span class="o">.</span><span class="n">Fatal</span><span class="p">(</span><span class="n">err</span><span class="p">)</span><span class="x">
	</span><span class="p">}</span><span class="x">

	</span><span class="n">baconNum</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="n">random</span><span class="p">(</span><span class="m">0</span><span class="p">,</span><span class="x"> </span><span class="m">9</span><span class="p">)</span><span class="x">
	</span><span class="n">items</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="n">jsonData</span><span class="p">[</span><span class="s">"items"</span><span class="p">]</span><span class="o">.</span><span class="p">([]</span><span class="k">interface</span><span class="p">{})</span><span class="x">

	</span><span class="n">baconData</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="n">items</span><span class="p">[</span><span class="n">baconNum</span><span class="p">]</span><span class="o">.</span><span class="p">(</span><span class="k">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="k">interface</span><span class="p">{})</span><span class="x">
	</span><span class="k">return</span><span class="x"> </span><span class="n">baconData</span><span class="p">[</span><span class="s">"link"</span><span class="p">]</span><span class="o">.</span><span class="p">(</span><span class="kt">string</span><span class="p">)</span><span class="x">
</span><span class="p">}</span></code></pre></figure>

<p>Alright, let’s walk through these functions. Assume that the <code class="highlighter-rouge">receiveBacon</code> function has been called with a baconType of simply “bacon”:</p>
<ul>
  <li>We grab the custom search and API strings from our environment</li>
  <li>Generate a random number between 1 and 10. This will correspond to the page on Google Images</li>
  <li>Craft our request URL and do an <code class="highlighter-rouge">http.Get</code> on it</li>
  <li>Once we’ve got our response, unmarshal the json into the jsonData map</li>
  <li>Pick on of the 10 responses on the page by generating another random.</li>
  <li>Return the image link</li>
</ul>

<p>Once the image link is returned, our <code class="highlighter-rouge">respond</code> function simply pops it into Slack so we can enjoy our bacon!</p>

<p>Here’s the entire testbot.go file:</p>

<figure class="highlight"><pre><code class="language-go" data-lang="go"><span class="k">package</span><span class="x"> </span><span class="n">main</span><span class="x">

</span><span class="k">import</span><span class="x"> </span><span class="p">(</span><span class="x">
	</span><span class="s">"encoding/json"</span><span class="x">
	</span><span class="s">"fmt"</span><span class="x">
	</span><span class="s">"io/ioutil"</span><span class="x">
	</span><span class="s">"log"</span><span class="x">
	</span><span class="s">"math/rand"</span><span class="x">
	</span><span class="s">"net/http"</span><span class="x">
	</span><span class="s">"os"</span><span class="x">
	</span><span class="s">"strconv"</span><span class="x">
	</span><span class="s">"strings"</span><span class="x">
	</span><span class="s">"time"</span><span class="x">

	</span><span class="s">"github.com/nlopes/slack"</span><span class="x">
</span><span class="p">)</span><span class="x">

</span><span class="k">func</span><span class="x"> </span><span class="n">main</span><span class="p">()</span><span class="x"> </span><span class="p">{</span><span class="x">

	</span><span class="n">token</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="n">os</span><span class="o">.</span><span class="n">Getenv</span><span class="p">(</span><span class="s">"SLACK_TOKEN"</span><span class="p">)</span><span class="x">
	</span><span class="n">api</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="n">slack</span><span class="o">.</span><span class="n">New</span><span class="p">(</span><span class="n">token</span><span class="p">)</span><span class="x">
	</span><span class="n">api</span><span class="o">.</span><span class="n">SetDebug</span><span class="p">(</span><span class="no">true</span><span class="p">)</span><span class="x">

	</span><span class="n">rtm</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="n">api</span><span class="o">.</span><span class="n">NewRTM</span><span class="p">()</span><span class="x">
	</span><span class="k">go</span><span class="x"> </span><span class="n">rtm</span><span class="o">.</span><span class="n">ManageConnection</span><span class="p">()</span><span class="x">

</span><span class="n">Loop</span><span class="o">:</span><span class="x">
	</span><span class="k">for</span><span class="x"> </span><span class="p">{</span><span class="x">
		</span><span class="k">select</span><span class="x"> </span><span class="p">{</span><span class="x">
		</span><span class="k">case</span><span class="x"> </span><span class="n">msg</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="o">&lt;-</span><span class="n">rtm</span><span class="o">.</span><span class="n">IncomingEvents</span><span class="o">:</span><span class="x">
			</span><span class="n">fmt</span><span class="o">.</span><span class="n">Print</span><span class="p">(</span><span class="s">"Event Received: "</span><span class="p">)</span><span class="x">
			</span><span class="k">switch</span><span class="x"> </span><span class="n">ev</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="n">msg</span><span class="o">.</span><span class="n">Data</span><span class="o">.</span><span class="p">(</span><span class="k">type</span><span class="p">)</span><span class="x"> </span><span class="p">{</span><span class="x">
			</span><span class="k">case</span><span class="x"> </span><span class="o">*</span><span class="n">slack</span><span class="o">.</span><span class="n">ConnectedEvent</span><span class="o">:</span><span class="x">
				</span><span class="n">fmt</span><span class="o">.</span><span class="n">Println</span><span class="p">(</span><span class="s">"Connection counter:"</span><span class="p">,</span><span class="x"> </span><span class="n">ev</span><span class="o">.</span><span class="n">ConnectionCount</span><span class="p">)</span><span class="x">

			</span><span class="k">case</span><span class="x"> </span><span class="o">*</span><span class="n">slack</span><span class="o">.</span><span class="n">MessageEvent</span><span class="o">:</span><span class="x">
				</span><span class="n">fmt</span><span class="o">.</span><span class="n">Printf</span><span class="p">(</span><span class="s">"Message: %v</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span><span class="x"> </span><span class="n">ev</span><span class="p">)</span><span class="x">
				</span><span class="n">info</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="n">rtm</span><span class="o">.</span><span class="n">GetInfo</span><span class="p">()</span><span class="x">
				</span><span class="n">prefix</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="n">fmt</span><span class="o">.</span><span class="n">Sprintf</span><span class="p">(</span><span class="s">"&lt;@%s&gt; "</span><span class="p">,</span><span class="x"> </span><span class="n">info</span><span class="o">.</span><span class="n">User</span><span class="o">.</span><span class="n">ID</span><span class="p">)</span><span class="x">

				</span><span class="k">if</span><span class="x"> </span><span class="n">ev</span><span class="o">.</span><span class="n">User</span><span class="x"> </span><span class="o">!=</span><span class="x"> </span><span class="n">info</span><span class="o">.</span><span class="n">User</span><span class="o">.</span><span class="n">ID</span><span class="x"> </span><span class="o">&amp;&amp;</span><span class="x"> </span><span class="n">strings</span><span class="o">.</span><span class="n">HasPrefix</span><span class="p">(</span><span class="n">ev</span><span class="o">.</span><span class="n">Text</span><span class="p">,</span><span class="x"> </span><span class="n">prefix</span><span class="p">)</span><span class="x"> </span><span class="p">{</span><span class="x">
					</span><span class="n">respond</span><span class="p">(</span><span class="n">rtm</span><span class="p">,</span><span class="x"> </span><span class="n">ev</span><span class="p">,</span><span class="x"> </span><span class="n">prefix</span><span class="p">)</span><span class="x">
				</span><span class="p">}</span><span class="x">

			</span><span class="k">case</span><span class="x"> </span><span class="o">*</span><span class="n">slack</span><span class="o">.</span><span class="n">RTMError</span><span class="o">:</span><span class="x">
				</span><span class="n">fmt</span><span class="o">.</span><span class="n">Printf</span><span class="p">(</span><span class="s">"Error: %s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span><span class="x"> </span><span class="n">ev</span><span class="o">.</span><span class="n">Error</span><span class="p">())</span><span class="x">

			</span><span class="k">case</span><span class="x"> </span><span class="o">*</span><span class="n">slack</span><span class="o">.</span><span class="n">InvalidAuthEvent</span><span class="o">:</span><span class="x">
				</span><span class="n">fmt</span><span class="o">.</span><span class="n">Printf</span><span class="p">(</span><span class="s">"Invalid credentials"</span><span class="p">)</span><span class="x">
				</span><span class="k">break</span><span class="x"> </span><span class="n">Loop</span><span class="x">

			</span><span class="k">default</span><span class="o">:</span><span class="x">
				</span><span class="c">//Take no action</span><span class="x">
			</span><span class="p">}</span><span class="x">
		</span><span class="p">}</span><span class="x">
	</span><span class="p">}</span><span class="x">
</span><span class="p">}</span><span class="x">

</span><span class="k">func</span><span class="x"> </span><span class="n">respond</span><span class="p">(</span><span class="n">rtm</span><span class="x"> </span><span class="o">*</span><span class="n">slack</span><span class="o">.</span><span class="n">RTM</span><span class="p">,</span><span class="x"> </span><span class="n">msg</span><span class="x"> </span><span class="o">*</span><span class="n">slack</span><span class="o">.</span><span class="n">MessageEvent</span><span class="p">,</span><span class="x"> </span><span class="n">prefix</span><span class="x"> </span><span class="kt">string</span><span class="p">)</span><span class="x"> </span><span class="p">{</span><span class="x">
	</span><span class="k">var</span><span class="x"> </span><span class="n">response</span><span class="x"> </span><span class="kt">string</span><span class="x">
	</span><span class="n">text</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="n">msg</span><span class="o">.</span><span class="n">Text</span><span class="x">
	</span><span class="n">text</span><span class="x"> </span><span class="o">=</span><span class="x"> </span><span class="n">strings</span><span class="o">.</span><span class="n">TrimPrefix</span><span class="p">(</span><span class="n">text</span><span class="p">,</span><span class="x"> </span><span class="n">prefix</span><span class="p">)</span><span class="x">
	</span><span class="n">text</span><span class="x"> </span><span class="o">=</span><span class="x"> </span><span class="n">strings</span><span class="o">.</span><span class="n">TrimSpace</span><span class="p">(</span><span class="n">text</span><span class="p">)</span><span class="x">
	</span><span class="n">text</span><span class="x"> </span><span class="o">=</span><span class="x"> </span><span class="n">strings</span><span class="o">.</span><span class="n">ToLower</span><span class="p">(</span><span class="n">text</span><span class="p">)</span><span class="x">

	</span><span class="n">acceptedPhrases</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="k">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kt">bool</span><span class="p">{</span><span class="x">
		</span><span class="s">"hook it up"</span><span class="o">:</span><span class="x">     </span><span class="no">true</span><span class="p">,</span><span class="x">
		</span><span class="s">"hit me"</span><span class="o">:</span><span class="x">         </span><span class="no">true</span><span class="p">,</span><span class="x">
		</span><span class="s">"bacon me"</span><span class="o">:</span><span class="x">       </span><span class="no">true</span><span class="p">,</span><span class="x">
		</span><span class="s">"no pork please"</span><span class="o">:</span><span class="x"> </span><span class="no">true</span><span class="p">,</span><span class="x">
	</span><span class="p">}</span><span class="x">

	</span><span class="k">if</span><span class="x"> </span><span class="n">acceptedPhrases</span><span class="p">[</span><span class="n">text</span><span class="p">]</span><span class="x"> </span><span class="p">{</span><span class="x">
		</span><span class="k">var</span><span class="x"> </span><span class="n">baconString</span><span class="x"> </span><span class="kt">string</span><span class="x">
		</span><span class="k">if</span><span class="x"> </span><span class="n">text</span><span class="x"> </span><span class="o">==</span><span class="x"> </span><span class="s">"no pork please"</span><span class="x"> </span><span class="p">{</span><span class="x">
			</span><span class="n">baconString</span><span class="x"> </span><span class="o">=</span><span class="x"> </span><span class="s">"beef+bacon"</span><span class="x">
		</span><span class="p">}</span><span class="x"> </span><span class="k">else</span><span class="x"> </span><span class="p">{</span><span class="x">
			</span><span class="n">baconString</span><span class="x"> </span><span class="o">=</span><span class="x"> </span><span class="s">"bacon"</span><span class="x">
		</span><span class="p">}</span><span class="x">
		</span><span class="n">response</span><span class="x"> </span><span class="o">=</span><span class="x"> </span><span class="n">receiveBacon</span><span class="p">(</span><span class="n">baconString</span><span class="p">)</span><span class="x">
		</span><span class="n">rtm</span><span class="o">.</span><span class="n">SendMessage</span><span class="p">(</span><span class="n">rtm</span><span class="o">.</span><span class="n">NewOutgoingMessage</span><span class="p">(</span><span class="n">response</span><span class="p">,</span><span class="x"> </span><span class="n">msg</span><span class="o">.</span><span class="n">Channel</span><span class="p">))</span><span class="x">
	</span><span class="p">}</span><span class="x">
</span><span class="p">}</span><span class="x">

</span><span class="k">func</span><span class="x"> </span><span class="n">random</span><span class="p">(</span><span class="n">min</span><span class="p">,</span><span class="x"> </span><span class="n">max</span><span class="x"> </span><span class="kt">int</span><span class="p">)</span><span class="x"> </span><span class="kt">int</span><span class="x"> </span><span class="p">{</span><span class="x">
	</span><span class="n">rand</span><span class="o">.</span><span class="n">Seed</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">Now</span><span class="p">()</span><span class="o">.</span><span class="n">Unix</span><span class="p">())</span><span class="x">
	</span><span class="k">return</span><span class="x"> </span><span class="n">rand</span><span class="o">.</span><span class="n">Intn</span><span class="p">(</span><span class="n">max</span><span class="o">-</span><span class="n">min</span><span class="p">)</span><span class="x"> </span><span class="o">+</span><span class="x"> </span><span class="n">min</span><span class="x">
</span><span class="p">}</span><span class="x">

</span><span class="k">func</span><span class="x"> </span><span class="n">receiveBacon</span><span class="p">(</span><span class="n">baconType</span><span class="x"> </span><span class="kt">string</span><span class="p">)</span><span class="x"> </span><span class="kt">string</span><span class="x"> </span><span class="p">{</span><span class="x">

	</span><span class="n">cxString</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="n">os</span><span class="o">.</span><span class="n">Getenv</span><span class="p">(</span><span class="s">"CX_STRING"</span><span class="p">)</span><span class="x">
	</span><span class="n">apiKey</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="n">os</span><span class="o">.</span><span class="n">Getenv</span><span class="p">(</span><span class="s">"API_KEY"</span><span class="p">)</span><span class="x">
	</span><span class="n">startNum</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="n">strconv</span><span class="o">.</span><span class="n">Itoa</span><span class="p">(</span><span class="n">random</span><span class="p">(</span><span class="m">1</span><span class="p">,</span><span class="x"> </span><span class="m">10</span><span class="p">))</span><span class="x">
	</span><span class="n">url</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="s">"https://www.googleapis.com/customsearch/v1?cx="</span><span class="x"> </span><span class="o">+</span><span class="x"> </span><span class="n">cxString</span><span class="x"> </span><span class="o">+</span><span class="x"> </span><span class="s">"&amp;key="</span><span class="x"> </span><span class="o">+</span><span class="x"> </span><span class="n">apiKey</span><span class="x"> </span><span class="o">+</span><span class="x"> </span><span class="s">"&amp;q="</span><span class="x"> </span><span class="o">+</span><span class="x"> </span><span class="n">baconType</span><span class="x"> </span><span class="o">+</span><span class="x"> </span><span class="s">"&amp;searchType=image&amp;safe=medium&amp;start="</span><span class="x"> </span><span class="o">+</span><span class="x"> </span><span class="n">startNum</span><span class="x">
	</span><span class="n">fmt</span><span class="o">.</span><span class="n">Printf</span><span class="p">(</span><span class="n">url</span><span class="p">)</span><span class="x">
	</span><span class="n">response</span><span class="p">,</span><span class="x"> </span><span class="n">err</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="n">http</span><span class="o">.</span><span class="n">Get</span><span class="p">(</span><span class="n">url</span><span class="p">)</span><span class="x">
	</span><span class="k">if</span><span class="x"> </span><span class="n">err</span><span class="x"> </span><span class="o">!=</span><span class="x"> </span><span class="no">nil</span><span class="x"> </span><span class="p">{</span><span class="x">
		</span><span class="n">log</span><span class="o">.</span><span class="n">Fatal</span><span class="p">(</span><span class="n">err</span><span class="p">)</span><span class="x">
	</span><span class="p">}</span><span class="x">

	</span><span class="k">defer</span><span class="x"> </span><span class="n">response</span><span class="o">.</span><span class="n">Body</span><span class="o">.</span><span class="n">Close</span><span class="p">()</span><span class="x">
	</span><span class="n">body</span><span class="p">,</span><span class="x"> </span><span class="n">err</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="n">ioutil</span><span class="o">.</span><span class="n">ReadAll</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">Body</span><span class="p">)</span><span class="x">
	</span><span class="k">if</span><span class="x"> </span><span class="n">err</span><span class="x"> </span><span class="o">!=</span><span class="x"> </span><span class="no">nil</span><span class="x"> </span><span class="p">{</span><span class="x">
		</span><span class="n">log</span><span class="o">.</span><span class="n">Fatal</span><span class="p">(</span><span class="n">err</span><span class="p">)</span><span class="x">
	</span><span class="p">}</span><span class="x">

	</span><span class="k">var</span><span class="x"> </span><span class="n">jsonData</span><span class="x"> </span><span class="k">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="k">interface</span><span class="p">{}</span><span class="x">
	</span><span class="k">if</span><span class="x"> </span><span class="n">err</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="n">json</span><span class="o">.</span><span class="n">Unmarshal</span><span class="p">(</span><span class="n">body</span><span class="p">,</span><span class="x"> </span><span class="o">&amp;</span><span class="n">jsonData</span><span class="p">);</span><span class="x"> </span><span class="n">err</span><span class="x"> </span><span class="o">!=</span><span class="x"> </span><span class="no">nil</span><span class="x"> </span><span class="p">{</span><span class="x">
		</span><span class="n">log</span><span class="o">.</span><span class="n">Fatal</span><span class="p">(</span><span class="n">err</span><span class="p">)</span><span class="x">
	</span><span class="p">}</span><span class="x">

	</span><span class="n">baconNum</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="n">random</span><span class="p">(</span><span class="m">0</span><span class="p">,</span><span class="x"> </span><span class="m">9</span><span class="p">)</span><span class="x">
	</span><span class="n">items</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="n">jsonData</span><span class="p">[</span><span class="s">"items"</span><span class="p">]</span><span class="o">.</span><span class="p">([]</span><span class="k">interface</span><span class="p">{})</span><span class="x">

	</span><span class="n">baconData</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="n">items</span><span class="p">[</span><span class="n">baconNum</span><span class="p">]</span><span class="o">.</span><span class="p">(</span><span class="k">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="k">interface</span><span class="p">{})</span><span class="x">
	</span><span class="k">return</span><span class="x"> </span><span class="n">baconData</span><span class="p">[</span><span class="s">"link"</span><span class="p">]</span><span class="o">.</span><span class="p">(</span><span class="kt">string</span><span class="p">)</span><span class="x">
</span><span class="p">}</span></code></pre></figure>

<h2 id="try-it-out"><strong>Try It Out</strong></h2>

<p>Similar to what we did yesterday, let’s rebuild our go binary and then our Docker image:</p>
<ul>
  <li>Build the go binary with <code class="highlighter-rouge">GOOS=linux GOARCH=amd64 go build</code> in the directory we created.</li>
  <li>Create the container image: <code class="highlighter-rouge">docker build -t testbot .</code></li>
  <li>Run it by adding the new necessary env vars: 
<code class="highlighter-rouge">docker run -ti -e SLACK_TOKEN=xxxxxxxxxxxx -e CX_STRING=11111111:aaaaaa \</code>
<code class="highlighter-rouge">-e API_KEY=abcdefghijklmnop123 testbot</code></li>
  <li>Enjoy your hard earned bacon! You’ll notice I renamed my bot @baconator.
<a href="/img/posts/2017-03-03-Slack-Bot-Image-Search/bacon.gif">
<img src="/img/posts/2017-03-03-Slack-Bot-Image-Search/bacon.gif" style="max-width:75%; border:solid 1px;" /></a></li>
</ul>

  </div><!-- /.entry-content -->
</article><!-- /.hentry -->

<article class="hentry">
  <header>
    
    <div class="entry-meta">
      <span class="entry-date date published updated"><time datetime="2017-03-02T00:00:00-05:00"><a href="https://rsmitty.github.io/Slack-Bot/">March 02, 2017</a></time></span><span class="author vcard"><span class="fn"><a href="https://rsmitty.github.io/about/" title="About Spencer Smith">Spencer Smith</a></span></span>
      
      <span class="entry-reading-time">
        <i class="fa fa-clock-o"></i>
        
Reading time ~5 minutes
      </span><!-- /.entry-reading-time -->
      
    </div><!-- /.entry-meta -->
    
      <h1 class="entry-title"><a href="https://rsmitty.github.io/Slack-Bot/" rel="bookmark" title="Writing a Slack Bot with Golang" itemprop="url">Writing a Slack Bot with Golang</a></h1>
    
  </header>
  <div class="entry-content">
    <p>Hey y’all. Hope everyone is doing well. Today we’ll walk through writing a little bot for Slack using Golang. This is pretty straightforward, so this post will also be short and sweet. That said, a good bot can absolutely be a fun and interesting way to add some extra value to Slack for your org. We have one at Solinea that responds to our requests with pics of bacon. Clearly priceless.</p>

<h2 id="use-whats-already-out-there"><strong>Use What’s Already Out There</strong></h2>

<p>I spent some time looking at the different golang options out there for the Slack API. I landed on <a href="https://github.com/nlopes/slack">this one</a> as the one that most folks seem to be using for go. Let’s setup what we need.</p>

<ul>
  <li>Create a development directory. I called mine testbot. <code class="highlighter-rouge">mkdir testbot; cd testbot;</code></li>
  <li>Touch a couple of different files that we’ll use for our bot. <code class="highlighter-rouge">touch testbot.go Dockerfile</code></li>
  <li>Open up <code class="highlighter-rouge">touchbot.go</code> for editing.</li>
</ul>

<h2 id="setup-slack"><strong>Setup Slack</strong></h2>

<p>Before we get any further, we need to get Slack setup properly.</p>

<ul>
  <li>Head to <code class="highlighter-rouge">https://$YOUR_ORG.slack.com/apps/A0F7YS25R-bots</code> to get to the Bots app page.</li>
  <li>Hit “Add Configuration”</li>
  <li>
    <p>Give your bot a name. Again, I used “@testbot”.
<a href="/img/posts/2017-03-02-Slack-Bot/slack-app-creation.png">
<img src="/img/posts/2017-03-02-Slack-Bot/slack-app-creation.png" style="max-width:75%; border:solid 1px;" /></a></p>
  </li>
  <li>Once it’s created, copy the API Token somewhere safe. We’ll need that to connect to Slack.</li>
</ul>

<p>This should be the minimum that’s necessary for Slack. Feel free to populate the other fields like name, description, etc.</p>

<h2 id="get-going"><strong>Get Going</strong></h2>

<p>The slack library we’re using has some good getting started examples (for all kinds of Slack stuff!), but I just wanted the bare minimum to get a bot to respond.</p>
<ul>
  <li>Let’s populate <code class="highlighter-rouge">touchbot.go</code> with the following:</li>
</ul>

<figure class="highlight"><pre><code class="language-go" data-lang="go"><span class="k">package</span><span class="x"> </span><span class="n">main</span><span class="x">

</span><span class="k">import</span><span class="x"> </span><span class="p">(</span><span class="x">
	</span><span class="s">"fmt"</span><span class="x">
	</span><span class="s">"os"</span><span class="x">
	</span><span class="s">"strings"</span><span class="x">

	</span><span class="s">"github.com/nlopes/slack"</span><span class="x">
</span><span class="p">)</span><span class="x">

</span><span class="k">func</span><span class="x"> </span><span class="n">main</span><span class="p">()</span><span class="x"> </span><span class="p">{</span><span class="x">

	</span><span class="n">token</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="n">os</span><span class="o">.</span><span class="n">Getenv</span><span class="p">(</span><span class="s">"SLACK_TOKEN"</span><span class="p">)</span><span class="x">
	</span><span class="n">api</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="n">slack</span><span class="o">.</span><span class="n">New</span><span class="p">(</span><span class="n">token</span><span class="p">)</span><span class="x">
	</span><span class="n">rtm</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="n">api</span><span class="o">.</span><span class="n">NewRTM</span><span class="p">()</span><span class="x">
	</span><span class="k">go</span><span class="x"> </span><span class="n">rtm</span><span class="o">.</span><span class="n">ManageConnection</span><span class="p">()</span><span class="x">

</span><span class="n">Loop</span><span class="o">:</span><span class="x">
	</span><span class="k">for</span><span class="x"> </span><span class="p">{</span><span class="x">
		</span><span class="k">select</span><span class="x"> </span><span class="p">{</span><span class="x">
		</span><span class="k">case</span><span class="x"> </span><span class="n">msg</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="o">&lt;-</span><span class="n">rtm</span><span class="o">.</span><span class="n">IncomingEvents</span><span class="o">:</span><span class="x">
			</span><span class="n">fmt</span><span class="o">.</span><span class="n">Print</span><span class="p">(</span><span class="s">"Event Received: "</span><span class="p">)</span><span class="x">
			</span><span class="k">switch</span><span class="x"> </span><span class="n">ev</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="n">msg</span><span class="o">.</span><span class="n">Data</span><span class="o">.</span><span class="p">(</span><span class="k">type</span><span class="p">)</span><span class="x"> </span><span class="p">{</span><span class="x">
			</span><span class="k">case</span><span class="x"> </span><span class="o">*</span><span class="n">slack</span><span class="o">.</span><span class="n">ConnectedEvent</span><span class="o">:</span><span class="x">
				</span><span class="n">fmt</span><span class="o">.</span><span class="n">Println</span><span class="p">(</span><span class="s">"Connection counter:"</span><span class="p">,</span><span class="x"> </span><span class="n">ev</span><span class="o">.</span><span class="n">ConnectionCount</span><span class="p">)</span><span class="x">

			</span><span class="k">case</span><span class="x"> </span><span class="o">*</span><span class="n">slack</span><span class="o">.</span><span class="n">MessageEvent</span><span class="o">:</span><span class="x">
				</span><span class="n">fmt</span><span class="o">.</span><span class="n">Printf</span><span class="p">(</span><span class="s">"Message: %v</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span><span class="x"> </span><span class="n">ev</span><span class="p">)</span><span class="x">
				</span><span class="n">info</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="n">rtm</span><span class="o">.</span><span class="n">GetInfo</span><span class="p">()</span><span class="x">
				</span><span class="n">prefix</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="n">fmt</span><span class="o">.</span><span class="n">Sprintf</span><span class="p">(</span><span class="s">"&lt;@%s&gt; "</span><span class="p">,</span><span class="x"> </span><span class="n">info</span><span class="o">.</span><span class="n">User</span><span class="o">.</span><span class="n">ID</span><span class="p">)</span><span class="x">

				</span><span class="k">if</span><span class="x"> </span><span class="n">ev</span><span class="o">.</span><span class="n">User</span><span class="x"> </span><span class="o">!=</span><span class="x"> </span><span class="n">info</span><span class="o">.</span><span class="n">User</span><span class="o">.</span><span class="n">ID</span><span class="x"> </span><span class="o">&amp;&amp;</span><span class="x"> </span><span class="n">strings</span><span class="o">.</span><span class="n">HasPrefix</span><span class="p">(</span><span class="n">ev</span><span class="o">.</span><span class="n">Text</span><span class="p">,</span><span class="x"> </span><span class="n">prefix</span><span class="p">)</span><span class="x"> </span><span class="p">{</span><span class="x">
					</span><span class="n">rtm</span><span class="o">.</span><span class="n">SendMessage</span><span class="p">(</span><span class="n">rtm</span><span class="o">.</span><span class="n">NewOutgoingMessage</span><span class="p">(</span><span class="s">"What's up buddy!?!?"</span><span class="p">,</span><span class="x"> </span><span class="n">ev</span><span class="o">.</span><span class="n">Channel</span><span class="p">))</span><span class="x">
				</span><span class="p">}</span><span class="x">

			</span><span class="k">case</span><span class="x"> </span><span class="o">*</span><span class="n">slack</span><span class="o">.</span><span class="n">RTMError</span><span class="o">:</span><span class="x">
				</span><span class="n">fmt</span><span class="o">.</span><span class="n">Printf</span><span class="p">(</span><span class="s">"Error: %s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span><span class="x"> </span><span class="n">ev</span><span class="o">.</span><span class="n">Error</span><span class="p">())</span><span class="x">

			</span><span class="k">case</span><span class="x"> </span><span class="o">*</span><span class="n">slack</span><span class="o">.</span><span class="n">InvalidAuthEvent</span><span class="o">:</span><span class="x">
				</span><span class="n">fmt</span><span class="o">.</span><span class="n">Printf</span><span class="p">(</span><span class="s">"Invalid credentials"</span><span class="p">)</span><span class="x">
				</span><span class="k">break</span><span class="x"> </span><span class="n">Loop</span><span class="x">

			</span><span class="k">default</span><span class="o">:</span><span class="x">
				</span><span class="c">//Take no action</span><span class="x">
			</span><span class="p">}</span><span class="x">
		</span><span class="p">}</span><span class="x">
	</span><span class="p">}</span><span class="x">
</span><span class="p">}</span></code></pre></figure>

<p>Let’s walk through some of this. The general flow goes:</p>
<ul>
  <li>Retrieve a Slack API token from our environment variables.</li>
  <li>Connect to Slack using the token and loop endlessly.</li>
  <li>When we receive an event, take action depending on what type of an event it is.</li>
</ul>

<p>Now, there’s other types of events that can be present, but these are the ones that give enough quick feedback to troubleshoot an error.</p>

<p>There’s a couple of other important bits when a “MessageEvent” occurs:</p>
<ul>
  <li>Get some basic info about our Slack session, just so we can fish our bot’s user name out of it.</li>
  <li>Set a prefix that should be met in order to warrant a response from us. This will look like <code class="highlighter-rouge">@testbot&lt;space&gt;</code> for me.</li>
  <li>If the original message wasn’t posted by our bot AND it contains our prefix <code class="highlighter-rouge">@testbot</code>, then we’ll respond to the channel. For now, we’ll only respond with “What’s up buddy!?!?”</li>
</ul>

<h2 id="bring-on-the-bots"><strong>Bring On The Bots</strong></h2>

<p>That’s actually enough to get a bot connected and responding. Let’s check it out and then we’ll make it better.</p>

<ul>
  <li>From your terminal, set a SLACK_TOKEN env variable with the value we got earlier from the bot configuration. <code class="highlighter-rouge">export SLACK_TOKEN="xxxyyyzzz111222333"</code></li>
  <li>Run your bot with <code class="highlighter-rouge">go run testbot.go</code>. This should show some terminal output that looks like it’s connecting to slack and reading some early events.</li>
  <li>
    <p>In your slack client, invite testbot to a channel of your choosing. <code class="highlighter-rouge">/invite @testbot</code>
<a href="/img/posts/2017-03-02-Slack-Bot/invite-bot.png">
<img src="/img/posts/2017-03-02-Slack-Bot/invite-bot.png" style="max-width:75%; border:solid 1px;" /></a></p>
  </li>
  <li>Now, let’s see if our buddy responds. Type something like <code class="highlighter-rouge">@testbot hey!</code>. You should see:
<a href="/img/posts/2017-03-02-Slack-Bot/first-hello.png">
<img src="/img/posts/2017-03-02-Slack-Bot/first-hello.png" style="max-width:50%; border:solid 1px;" /></a></li>
</ul>

<h2 id="but-wait-theres-more"><strong>But Wait, There’s More</strong></h2>

<p>Sweet! It works! But you’ll probably notice pretty quick that if the only thing you’re looking for is the prefix, testbot is going to respond to ANYTHING you say to it. That can get a bit annoying. Let’s draft a responder and we can filter things out a bit.</p>

<ul>
  <li>Create a function below your main function called “respond”. This code block should look like this:</li>
</ul>

<figure class="highlight"><pre><code class="language-go" data-lang="go"><span class="k">func</span><span class="x"> </span><span class="n">respond</span><span class="p">(</span><span class="n">rtm</span><span class="x"> </span><span class="o">*</span><span class="n">slack</span><span class="o">.</span><span class="n">RTM</span><span class="p">,</span><span class="x"> </span><span class="n">msg</span><span class="x"> </span><span class="o">*</span><span class="n">slack</span><span class="o">.</span><span class="n">MessageEvent</span><span class="p">,</span><span class="x"> </span><span class="n">prefix</span><span class="x"> </span><span class="kt">string</span><span class="p">)</span><span class="x"> </span><span class="p">{</span><span class="x">
	</span><span class="k">var</span><span class="x"> </span><span class="n">response</span><span class="x"> </span><span class="kt">string</span><span class="x">
	</span><span class="n">text</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="n">msg</span><span class="o">.</span><span class="n">Text</span><span class="x">
	</span><span class="n">text</span><span class="x"> </span><span class="o">=</span><span class="x"> </span><span class="n">strings</span><span class="o">.</span><span class="n">TrimPrefix</span><span class="p">(</span><span class="n">text</span><span class="p">,</span><span class="x"> </span><span class="n">prefix</span><span class="p">)</span><span class="x">
	</span><span class="n">text</span><span class="x"> </span><span class="o">=</span><span class="x"> </span><span class="n">strings</span><span class="o">.</span><span class="n">TrimSpace</span><span class="p">(</span><span class="n">text</span><span class="p">)</span><span class="x">
	</span><span class="n">text</span><span class="x"> </span><span class="o">=</span><span class="x"> </span><span class="n">strings</span><span class="o">.</span><span class="n">ToLower</span><span class="p">(</span><span class="n">text</span><span class="p">)</span><span class="x">

	</span><span class="n">acceptedGreetings</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="k">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kt">bool</span><span class="p">{</span><span class="x">
		</span><span class="s">"what's up?"</span><span class="o">:</span><span class="x"> </span><span class="no">true</span><span class="p">,</span><span class="x">
		</span><span class="s">"hey!"</span><span class="o">:</span><span class="x">       </span><span class="no">true</span><span class="p">,</span><span class="x">
		</span><span class="s">"yo"</span><span class="o">:</span><span class="x">         </span><span class="no">true</span><span class="p">,</span><span class="x">
	</span><span class="p">}</span><span class="x">
	</span><span class="n">acceptedHowAreYou</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="k">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kt">bool</span><span class="p">{</span><span class="x">
		</span><span class="s">"how's it going?"</span><span class="o">:</span><span class="x"> </span><span class="no">true</span><span class="p">,</span><span class="x">
		</span><span class="s">"how are ya?"</span><span class="o">:</span><span class="x">     </span><span class="no">true</span><span class="p">,</span><span class="x">
		</span><span class="s">"feeling okay?"</span><span class="o">:</span><span class="x">   </span><span class="no">true</span><span class="p">,</span><span class="x">
	</span><span class="p">}</span><span class="x">

	</span><span class="k">if</span><span class="x"> </span><span class="n">acceptedGreetings</span><span class="p">[</span><span class="n">text</span><span class="p">]</span><span class="x"> </span><span class="p">{</span><span class="x">
		</span><span class="n">response</span><span class="x"> </span><span class="o">=</span><span class="x"> </span><span class="s">"What's up buddy!?!?!"</span><span class="x">
		</span><span class="n">rtm</span><span class="o">.</span><span class="n">SendMessage</span><span class="p">(</span><span class="n">rtm</span><span class="o">.</span><span class="n">NewOutgoingMessage</span><span class="p">(</span><span class="n">response</span><span class="p">,</span><span class="x"> </span><span class="n">msg</span><span class="o">.</span><span class="n">Channel</span><span class="p">))</span><span class="x">
	</span><span class="p">}</span><span class="x"> </span><span class="k">else</span><span class="x"> </span><span class="k">if</span><span class="x"> </span><span class="n">acceptedHowAreYou</span><span class="p">[</span><span class="n">text</span><span class="p">]</span><span class="x"> </span><span class="p">{</span><span class="x">
		</span><span class="n">response</span><span class="x"> </span><span class="o">=</span><span class="x"> </span><span class="s">"Good. How are you?"</span><span class="x">
		</span><span class="n">rtm</span><span class="o">.</span><span class="n">SendMessage</span><span class="p">(</span><span class="n">rtm</span><span class="o">.</span><span class="n">NewOutgoingMessage</span><span class="p">(</span><span class="n">response</span><span class="p">,</span><span class="x"> </span><span class="n">msg</span><span class="o">.</span><span class="n">Channel</span><span class="p">))</span><span class="x">
	</span><span class="p">}</span><span class="x">
</span><span class="p">}</span></code></pre></figure>

<ul>
  <li>Looking through this code block. We’re basically just receiving the message that came through and, from here, we’ll determine if it warrants a response.</li>
  <li>There’s two maps that contain some accepted strings. For this example, we’re just accepting some greetings and some “how are you?” type or questions.</li>
  <li>If those strings are matched, a message is sent in response.</li>
</ul>

<p>Now, we want to update our main function to use the respond function instead of posting messages directly. Your whole file should look like this:</p>

<figure class="highlight"><pre><code class="language-go" data-lang="go"><span class="k">package</span><span class="x"> </span><span class="n">main</span><span class="x">

</span><span class="k">import</span><span class="x"> </span><span class="p">(</span><span class="x">
	</span><span class="s">"fmt"</span><span class="x">
	</span><span class="s">"os"</span><span class="x">
	</span><span class="s">"strings"</span><span class="x">

	</span><span class="s">"github.com/nlopes/slack"</span><span class="x">
</span><span class="p">)</span><span class="x">

</span><span class="k">func</span><span class="x"> </span><span class="n">main</span><span class="p">()</span><span class="x"> </span><span class="p">{</span><span class="x">

	</span><span class="n">token</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="n">os</span><span class="o">.</span><span class="n">Getenv</span><span class="p">(</span><span class="s">"SLACK_TOKEN"</span><span class="p">)</span><span class="x">
	</span><span class="n">api</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="n">slack</span><span class="o">.</span><span class="n">New</span><span class="p">(</span><span class="n">token</span><span class="p">)</span><span class="x">
	</span><span class="n">api</span><span class="o">.</span><span class="n">SetDebug</span><span class="p">(</span><span class="no">true</span><span class="p">)</span><span class="x">

	</span><span class="n">rtm</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="n">api</span><span class="o">.</span><span class="n">NewRTM</span><span class="p">()</span><span class="x">
	</span><span class="k">go</span><span class="x"> </span><span class="n">rtm</span><span class="o">.</span><span class="n">ManageConnection</span><span class="p">()</span><span class="x">

</span><span class="n">Loop</span><span class="o">:</span><span class="x">
	</span><span class="k">for</span><span class="x"> </span><span class="p">{</span><span class="x">
		</span><span class="k">select</span><span class="x"> </span><span class="p">{</span><span class="x">
		</span><span class="k">case</span><span class="x"> </span><span class="n">msg</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="o">&lt;-</span><span class="n">rtm</span><span class="o">.</span><span class="n">IncomingEvents</span><span class="o">:</span><span class="x">
			</span><span class="n">fmt</span><span class="o">.</span><span class="n">Print</span><span class="p">(</span><span class="s">"Event Received: "</span><span class="p">)</span><span class="x">
			</span><span class="k">switch</span><span class="x"> </span><span class="n">ev</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="n">msg</span><span class="o">.</span><span class="n">Data</span><span class="o">.</span><span class="p">(</span><span class="k">type</span><span class="p">)</span><span class="x"> </span><span class="p">{</span><span class="x">
			</span><span class="k">case</span><span class="x"> </span><span class="o">*</span><span class="n">slack</span><span class="o">.</span><span class="n">ConnectedEvent</span><span class="o">:</span><span class="x">
				</span><span class="n">fmt</span><span class="o">.</span><span class="n">Println</span><span class="p">(</span><span class="s">"Connection counter:"</span><span class="p">,</span><span class="x"> </span><span class="n">ev</span><span class="o">.</span><span class="n">ConnectionCount</span><span class="p">)</span><span class="x">

			</span><span class="k">case</span><span class="x"> </span><span class="o">*</span><span class="n">slack</span><span class="o">.</span><span class="n">MessageEvent</span><span class="o">:</span><span class="x">
				</span><span class="n">fmt</span><span class="o">.</span><span class="n">Printf</span><span class="p">(</span><span class="s">"Message: %v</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span><span class="x"> </span><span class="n">ev</span><span class="p">)</span><span class="x">
				</span><span class="n">info</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="n">rtm</span><span class="o">.</span><span class="n">GetInfo</span><span class="p">()</span><span class="x">
				</span><span class="n">prefix</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="n">fmt</span><span class="o">.</span><span class="n">Sprintf</span><span class="p">(</span><span class="s">"&lt;@%s&gt; "</span><span class="p">,</span><span class="x"> </span><span class="n">info</span><span class="o">.</span><span class="n">User</span><span class="o">.</span><span class="n">ID</span><span class="p">)</span><span class="x">

				</span><span class="k">if</span><span class="x"> </span><span class="n">ev</span><span class="o">.</span><span class="n">User</span><span class="x"> </span><span class="o">!=</span><span class="x"> </span><span class="n">info</span><span class="o">.</span><span class="n">User</span><span class="o">.</span><span class="n">ID</span><span class="x"> </span><span class="o">&amp;&amp;</span><span class="x"> </span><span class="n">strings</span><span class="o">.</span><span class="n">HasPrefix</span><span class="p">(</span><span class="n">ev</span><span class="o">.</span><span class="n">Text</span><span class="p">,</span><span class="x"> </span><span class="n">prefix</span><span class="p">)</span><span class="x"> </span><span class="p">{</span><span class="x">
					</span><span class="n">respond</span><span class="p">(</span><span class="n">rtm</span><span class="p">,</span><span class="x"> </span><span class="n">ev</span><span class="p">,</span><span class="x"> </span><span class="n">prefix</span><span class="p">)</span><span class="x">
				</span><span class="p">}</span><span class="x">

			</span><span class="k">case</span><span class="x"> </span><span class="o">*</span><span class="n">slack</span><span class="o">.</span><span class="n">RTMError</span><span class="o">:</span><span class="x">
				</span><span class="n">fmt</span><span class="o">.</span><span class="n">Printf</span><span class="p">(</span><span class="s">"Error: %s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span><span class="x"> </span><span class="n">ev</span><span class="o">.</span><span class="n">Error</span><span class="p">())</span><span class="x">

			</span><span class="k">case</span><span class="x"> </span><span class="o">*</span><span class="n">slack</span><span class="o">.</span><span class="n">InvalidAuthEvent</span><span class="o">:</span><span class="x">
				</span><span class="n">fmt</span><span class="o">.</span><span class="n">Printf</span><span class="p">(</span><span class="s">"Invalid credentials"</span><span class="p">)</span><span class="x">
				</span><span class="k">break</span><span class="x"> </span><span class="n">Loop</span><span class="x">

			</span><span class="k">default</span><span class="o">:</span><span class="x">
				</span><span class="c">//Take no action</span><span class="x">
			</span><span class="p">}</span><span class="x">
		</span><span class="p">}</span><span class="x">
	</span><span class="p">}</span><span class="x">
</span><span class="p">}</span><span class="x">

</span><span class="k">func</span><span class="x"> </span><span class="n">respond</span><span class="p">(</span><span class="n">rtm</span><span class="x"> </span><span class="o">*</span><span class="n">slack</span><span class="o">.</span><span class="n">RTM</span><span class="p">,</span><span class="x"> </span><span class="n">msg</span><span class="x"> </span><span class="o">*</span><span class="n">slack</span><span class="o">.</span><span class="n">MessageEvent</span><span class="p">,</span><span class="x"> </span><span class="n">prefix</span><span class="x"> </span><span class="kt">string</span><span class="p">)</span><span class="x"> </span><span class="p">{</span><span class="x">
	</span><span class="k">var</span><span class="x"> </span><span class="n">response</span><span class="x"> </span><span class="kt">string</span><span class="x">
	</span><span class="n">text</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="n">msg</span><span class="o">.</span><span class="n">Text</span><span class="x">
	</span><span class="n">text</span><span class="x"> </span><span class="o">=</span><span class="x"> </span><span class="n">strings</span><span class="o">.</span><span class="n">TrimPrefix</span><span class="p">(</span><span class="n">text</span><span class="p">,</span><span class="x"> </span><span class="n">prefix</span><span class="p">)</span><span class="x">
	</span><span class="n">text</span><span class="x"> </span><span class="o">=</span><span class="x"> </span><span class="n">strings</span><span class="o">.</span><span class="n">TrimSpace</span><span class="p">(</span><span class="n">text</span><span class="p">)</span><span class="x">
	</span><span class="n">text</span><span class="x"> </span><span class="o">=</span><span class="x"> </span><span class="n">strings</span><span class="o">.</span><span class="n">ToLower</span><span class="p">(</span><span class="n">text</span><span class="p">)</span><span class="x">

	</span><span class="n">acceptedGreetings</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="k">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kt">bool</span><span class="p">{</span><span class="x">
		</span><span class="s">"what's up?"</span><span class="o">:</span><span class="x"> </span><span class="no">true</span><span class="p">,</span><span class="x">
		</span><span class="s">"hey!"</span><span class="o">:</span><span class="x">       </span><span class="no">true</span><span class="p">,</span><span class="x">
		</span><span class="s">"yo"</span><span class="o">:</span><span class="x">         </span><span class="no">true</span><span class="p">,</span><span class="x">
	</span><span class="p">}</span><span class="x">
	</span><span class="n">acceptedHowAreYou</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="k">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kt">bool</span><span class="p">{</span><span class="x">
		</span><span class="s">"how's it going?"</span><span class="o">:</span><span class="x"> </span><span class="no">true</span><span class="p">,</span><span class="x">
		</span><span class="s">"how are ya?"</span><span class="o">:</span><span class="x">     </span><span class="no">true</span><span class="p">,</span><span class="x">
		</span><span class="s">"feeling okay?"</span><span class="o">:</span><span class="x">   </span><span class="no">true</span><span class="p">,</span><span class="x">
	</span><span class="p">}</span><span class="x">

	</span><span class="k">if</span><span class="x"> </span><span class="n">acceptedGreetings</span><span class="p">[</span><span class="n">text</span><span class="p">]</span><span class="x"> </span><span class="p">{</span><span class="x">
		</span><span class="n">response</span><span class="x"> </span><span class="o">=</span><span class="x"> </span><span class="s">"What's up buddy!?!?!"</span><span class="x">
		</span><span class="n">rtm</span><span class="o">.</span><span class="n">SendMessage</span><span class="p">(</span><span class="n">rtm</span><span class="o">.</span><span class="n">NewOutgoingMessage</span><span class="p">(</span><span class="n">response</span><span class="p">,</span><span class="x"> </span><span class="n">msg</span><span class="o">.</span><span class="n">Channel</span><span class="p">))</span><span class="x">
	</span><span class="p">}</span><span class="x"> </span><span class="k">else</span><span class="x"> </span><span class="k">if</span><span class="x"> </span><span class="n">acceptedHowAreYou</span><span class="p">[</span><span class="n">text</span><span class="p">]</span><span class="x"> </span><span class="p">{</span><span class="x">
		</span><span class="n">response</span><span class="x"> </span><span class="o">=</span><span class="x"> </span><span class="s">"Good. How are you?"</span><span class="x">
		</span><span class="n">rtm</span><span class="o">.</span><span class="n">SendMessage</span><span class="p">(</span><span class="n">rtm</span><span class="o">.</span><span class="n">NewOutgoingMessage</span><span class="p">(</span><span class="n">response</span><span class="p">,</span><span class="x"> </span><span class="n">msg</span><span class="o">.</span><span class="n">Channel</span><span class="p">))</span><span class="x">
	</span><span class="p">}</span><span class="x">
</span><span class="p">}</span></code></pre></figure>

<h2 id="final-test"><strong>Final Test</strong></h2>

<ul>
  <li>Fire up your bot again with <code class="highlighter-rouge">go run testbot.go</code></li>
  <li>The bot should already be connected to your previous channel</li>
  <li>Greet your bot with <code class="highlighter-rouge">@testbot hey!</code></li>
  <li>Your bot will respond with our greeting response.</li>
  <li>Test out the second response: <code class="highlighter-rouge">@testbot how's it going?</code>
<a href="/img/posts/2017-03-02-Slack-Bot/final-responses.png">
<img src="/img/posts/2017-03-02-Slack-Bot/final-responses.png" style="max-width:50%; border:solid 1px;" /></a></li>
</ul>

<h2 id="build-and-run"><strong>Build and Run</strong></h2>

<p>This section will be quick. Let’s build a container image with our go binary in it. We’ll then be able to run it with Docker.</p>

<ul>
  <li>Add the following to your Dockerfile:</li>
</ul>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">FROM alpine:3.4

RUN apk add --no-cache ca-certificates

ADD testbot testbot
RUN chmod +x testbot

CMD <span class="o">[</span><span class="s2">"./testbot"</span><span class="o">]</span></code></pre></figure>

<ul>
  <li>Build the go binary with <code class="highlighter-rouge">GOOS=linux GOARCH=amd64 go build</code> in the directory we created.</li>
  <li>Create the container image: <code class="highlighter-rouge">docker build -t testbot .</code></li>
  <li>We can now run our container (anywhere!) with <code class="highlighter-rouge">docker run -d -e SLACK_TOKEN=xxxyyyzzz111222333 testbot</code></li>
</ul>

  </div><!-- /.entry-content -->
</article><!-- /.hentry -->



<div class="pagination">
  <ul class="inline-list">
    
    

    
    
      <li><strong class="current-page">1</strong></li>
    

    
    

    
    
    

    
      
        
        
        
        <li><a href="https://rsmitty.github.io/page2/">2</a></li>
      
    
      
        
        
        
        <li><a href="https://rsmitty.github.io/page3/">3</a></li>
      
    

    
    
      <li>…</li>
    

    
      <li><a href="https://rsmitty.github.io/page6/">6</a></li>
    

    
    
      <li><a href="https://rsmitty.github.io/page2/" class="btn">Next</a></li>
    
  </ul>
</div>

</div><!-- /#main -->

<div class="footer-wrapper">
  <footer role="contentinfo">
    <span>&copy; 2017 Spencer Smith. Powered by <a href="http://jekyllrb.com" rel="nofollow">Jekyll</a> using the <a href="https://mademistakes.com/work/hpstr-jekyll-theme/" rel="nofollow">HPSTR Theme</a>.</span>
  </footer>
</div><!-- /.footer-wrapper -->

<script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
<script>window.jQuery || document.write('<script src="https://rsmitty.github.io/assets/js/vendor/jquery-1.9.1.min.js"><\/script>')</script>
<script src="https://rsmitty.github.io/assets/js/scripts.min.js"></script>


<!-- Asynchronous Google Analytics snippet -->
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-61400214-1', 'auto');  
  ga('require', 'linkid', 'linkid.js');
  ga('send', 'pageview');
</script>


          

</body>
</html>
